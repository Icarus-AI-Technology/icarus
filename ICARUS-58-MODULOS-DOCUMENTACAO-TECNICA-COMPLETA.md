# üìö ICARUS v5.0 - DOCUMENTA√á√ÉO T√âCNICA COMPLETA DOS 58 M√ìDULOS

## üéØ Vis√£o Geral

**Sistema:** ICARUS v5.0 - ERP M√©dico-Hospitalar B2B para Distribuidoras de OPME  
**Vers√£o:** 5.0.2  
**Data:** Novembro 2025  
**Total de M√≥dulos:** 58  
**Total de Sub-M√≥dulos:** 147  
**Total de Formul√°rios:** 89  
**Total de Componentes:** 350+  
**Status:** ‚úÖ Documenta√ß√£o T√©cnica 100% Completa

---

## üìñ √çndice Completo

### CATEGORIA 1: DASHBOARD & ANALYTICS (6 m√≥dulos)
1. [Dashboard Principal](#01-dashboard-principal)
2. [KPI Dashboard Consolidado](#02-kpi-dashboard-consolidado)
3. [Analytics BI](#03-analytics-bi)
4. [Analytics de Predi√ß√£o](#04-analytics-de-predicao)
5. [BI Dashboard Interactive](#05-bi-dashboard-interactive)
6. [Relat√≥rios Executivos](#06-relatorios-executivos)

### CATEGORIA 2: CADASTROS & GEST√ÉO (8 m√≥dulos)
7. [Gest√£o de Cadastros](#07-gestao-de-cadastros)
8. [Grupos de Produtos OPME](#08-grupos-de-produtos-opme)
9. [Gest√£o de Usu√°rios e Permiss√µes](#09-gestao-de-usuarios-e-permissoes)
10. [Gest√£o de Contratos](#10-gestao-de-contratos)
11. [Gest√£o de Invent√°rio](#11-gestao-de-inventario)
12. [RH Gest√£o de Pessoas](#12-rh-gestao-de-pessoas)
13. [Relacionamento com Cliente](#13-relacionamento-com-cliente)
14. [Gest√£o de Leads](#14-gestao-de-leads)

### CATEGORIA 3: CIRURGIAS & PROCEDIMENTOS (4 m√≥dulos)
15. [Cirurgias e Procedimentos](#15-cirurgias-e-procedimentos)
16. [Licita√ß√µes e Propostas](#16-licitacoes-e-propostas)
17. [Tabela de Pre√ßos Viewer](#17-tabela-de-precos-viewer)
18. [Tabelas de Pre√ßos Form](#18-tabelas-de-precos-form)

### CATEGORIA 4: ESTOQUE & CONSIGNA√á√ÉO (5 m√≥dulos)
19. [Estoque IA](#19-estoque-ia)
20. [Consigna√ß√£o Avan√ßada](#20-consignacao-avancada)
21. [Rastreabilidade OPME](#21-rastreabilidade-opme)
22. [Telemetria IoT](#22-telemetria-iot)
23. [Manuten√ß√£o Preventiva](#23-manutencao-preventiva)

### CATEGORIA 5: COMPRAS & FORNECEDORES (4 m√≥dulos)
24. [Gest√£o de Compras](#24-gestao-de-compras)
25. [Notas de Compra](#25-notas-de-compra)
26. [Compras Internacionais](#26-compras-internacionais)
27. [Viabilidade de Importa√ß√£o](#27-viabilidade-de-importacao)

### CATEGORIA 6: VENDAS & CRM (5 m√≥dulos)
28. [CRM Vendas](#28-crm-vendas)
29. [Campanhas de Marketing](#29-campanhas-de-marketing)
30. [Tabelas de Pre√ßos Import](#30-tabelas-de-precos-import)
31. [Qualidade e Certifica√ß√£o](#31-qualidade-e-certificacao)
32. [Video Calls Manager](#32-video-calls-manager)

### CATEGORIA 7: FINANCEIRO & FATURAMENTO (7 m√≥dulos)
33. [Financeiro Avan√ßado](#33-financeiro-avancado)
34. [Contas a Receber IA](#34-contas-a-receber-ia)
35. [Faturamento Avan√ßado](#35-faturamento-avancado)
36. [Faturamento NFe Completo](#36-faturamento-nfe-completo)
37. [Gest√£o Cont√°bil](#37-gestao-contabil)
38. [Relat√≥rios Financeiros](#38-relatorios-financeiros)
39. [Relat√≥rios Regulat√≥rios](#39-relatorios-regulatorios)

### CATEGORIA 8: COMPLIANCE & AUDITORIA (3 m√≥dulos)
40. [Compliance e Auditoria](#40-compliance-e-auditoria)
41. [Compliance Auditoria Avan√ßado](#41-compliance-auditoria-avancado)
42. [Notifica√ß√µes Inteligentes](#42-notificacoes-inteligentes)

### CATEGORIA 9: IA & AUTOMA√á√ÉO (8 m√≥dulos)
43. [IA Central](#43-ia-central)
44. [Automa√ß√£o IA](#44-automacao-ia)
45. [Chatbot Metrics Dashboard](#45-chatbot-metrics-dashboard)
46. [Voice Analytics Dashboard](#46-voice-analytics-dashboard)
47. [Voice Biometrics Manager](#47-voice-biometrics-manager)
48. [Voice Macros Manager](#48-voice-macros-manager)
49. [Tooltip Analytics Dashboard](#49-tooltip-analytics-dashboard)
50. [Workflow Builder Visual](#50-workflow-builder-visual)

### CATEGORIA 10: SISTEMA & INTEGRA√á√ïES (13 m√≥dulos)
51. [Configura√ß√µes System](#51-configuracoes-system)
52. [Configura√ß√µes Avan√ßadas](#52-configuracoes-avancadas)
53. [System Health Dashboard](#53-system-health-dashboard)
54. [Integra√ß√µes Avan√ßadas](#54-integracoes-avancadas)
55. [Integrations Manager](#55-integrations-manager)
56. [API Gateway](#56-api-gateway)
57. [Webhooks Manager](#57-webhooks-manager)
58. [Log√≠stica Avan√ßada](#58-logistica-avancada)

---

# DOCUMENTA√á√ÉO DETALHADA DOS 58 M√ìDULOS

---

## 01. DASHBOARD PRINCIPAL

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `DashboardPrincipal.tsx` |
| **√çcone** | `LayoutDashboard` (Lucide React) |
| **Rota** | `/dashboard` |
| **Permiss√£o** | `dashboard.view` |
| **Categoria** | Dashboard & Analytics |
| **Status** | ‚úÖ Implementado 100% |
| **Prioridade** | Cr√≠tica |

### üéØ Descri√ß√£o

Dashboard central do ICARUS v5.0 com vis√£o consolidada de todos os KPIs cr√≠ticos do neg√≥cio, a√ß√µes r√°pidas para opera√ß√µes frequentes e navega√ß√£o inteligente para m√≥dulos principais.

### üìã Sub-M√≥dulos (4)

1. **Vis√£o Geral** - KPIs principais e m√©tricas consolidadas
2. **A√ß√µes R√°pidas** - Opera√ß√µes frequentes em cards
3. **Alertas e Notifica√ß√µes** - Central de avisos cr√≠ticos
4. **Navega√ß√£o R√°pida** - Acesso direto aos m√≥dulos

### üìù Formul√°rios (3)

#### 1. Nova Cirurgia (Modal)
- **Campos:** Paciente, M√©dico, Hospital, Data, Produtos OPME, Observa√ß√µes
- **Valida√ß√£o:** Estoque dispon√≠vel, agenda do m√©dico
- **Submit:** POST `/api/cirurgias`
- **Success:** Redirect para detalhes da cirurgia

#### 2. Adicionar Produto OPME (Modal)
- **Campos:** Nome, C√≥digo ANVISA, Grupo, Categoria, Pre√ßo, Fornecedor
- **Valida√ß√£o:** C√≥digo ANVISA (API externa)
- **Submit:** POST `/api/produtos-opme`
- **Success:** Produto criado e dispon√≠vel no estoque

#### 3. Emitir NFe R√°pida (Modal)
- **Campos:** Cliente, Itens, Valor Total, Observa√ß√µes
- **Valida√ß√£o:** Dados cadastrais completos
- **Submit:** POST `/api/faturamento/nfe/emitir`
- **Success:** NFe autorizada, XML/PDF dispon√≠vel

### üé® Componentes Utilizados

**Estrutura:**
- `<div className="space-y-6 p-6">` - Container principal
- `<div className="flex items-center justify-between">` - Header
- `<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">` - Grid KPIs

**Componentes Customizados:**
- `NeomorphicCard` (11x) - Cards de KPI
- `NeomorphicIconBox` (11x) - √çcones coloridos dos KPIs
- `Button` (8x) - A√ß√µes r√°pidas
- `MiniCardKPI` (4x) - Linha 1 de KPIs compactos

**Componentes UI:**
- `Dialog` (3x) - Modais de formul√°rios
- `Badge` (15x) - Status e tags
- `Progress` (5x) - Barras de progresso
- `Separator` (4x) - Divisores visuais

**√çcones (Lucide React):**
- `Activity` - Sistema Status
- `Users` - M√©dicos Ativos
- `Package` - Produtos OPME
- `Calendar` - Pedidos Urgentes
- `DollarSign` - Faturamento Mensal
- `MapPin` - Distribui√ß√£o Geogr√°fica
- `AlertTriangle` - Estoque Cr√≠tico
- `Truck` - Log√≠stica
- `Cpu` - Performance IA
- `Plus` - Adicionar (a√ß√µes)
- `FileText` - Documentos

### üîß Funcionalidades Frontend

#### A. KPIs Principais (11 cards)

**1. Sistema Status**
- **M√©trica:** Uptime do sistema (%)
- **Fonte:** WebSocket real-time
- **Update:** A cada 30s
- **Componente:** `<MiniCardCompacto>`
- **Props:** `icon={Activity}, colorVariant="blue", value="98%", trend={+2.3}`

**2. M√©dicos Ativos**
- **M√©trica:** Quantidade de m√©dicos com procedimentos no m√™s
- **Fonte:** `GET /api/dashboard/medicos-ativos`
- **Update:** 5 minutos
- **Componente:** `<MiniCardCompacto>`
- **Props:** `icon={Users}, colorVariant="cyan", value="1.847", trend={+12.5}`

**3. Produtos OPME**
- **M√©trica:** Total de produtos cadastrados
- **Fonte:** `GET /api/dashboard/produtos-total`
- **Update:** 10 minutos
- **Componente:** `<MiniCardCompacto>`
- **Props:** `icon={Package}, colorVariant="orange", value="12.4K", trend={+5.2}`

**4. Pedidos Urgentes**
- **M√©trica:** Pedidos com prazo < 48h
- **Fonte:** `GET /api/dashboard/pedidos-urgentes`
- **Update:** 2 minutos (cr√≠tico)
- **Componente:** `<MiniCardCompacto>`
- **Props:** `icon={Calendar}, colorVariant="red", value="89", trend={-8.1}`

**5. Faturamento Mensal**
- **M√©trica:** Receita do m√™s atual
- **Fonte:** `GET /api/dashboard/faturamento-mensal`
- **Update:** 15 minutos
- **Componente:** `<MiniCardMedio>`
- **Props:** `icon={DollarSign}, colorVariant="green", valuePrimary="R$ 3.8M", valueSecondary="R$ 127K", labelSecondary="m√©dia di√°ria"`

**6. Distribui√ß√£o Geogr√°fica**
- **M√©trica:** N√∫mero de hospitais atendidos
- **Fonte:** `GET /api/dashboard/distribuicao-geografica`
- **Update:** 30 minutos
- **Componente:** `<MiniCardMedio>`
- **Props:** `icon={MapPin}, colorVariant="indigo", valuePrimary="147", valueSecondary="28", labelSecondary="cidades"`

**7. Estoque Cr√≠tico**
- **M√©trica:** Produtos abaixo do estoque m√≠nimo
- **Fonte:** `GET /api/dashboard/estoque-critico`
- **Update:** 5 minutos
- **Componente:** `<MiniCardAvancado>`
- **Props:** `icon={AlertTriangle}, colorVariant="red", value="8", description="produtos em falta", chartData=[...]`

**8. Log√≠stica**
- **M√©trica:** Taxa de entregas no prazo (%)
- **Fonte:** `GET /api/dashboard/logistica-performance`
- **Update:** 15 minutos
- **Componente:** `<MiniCardAvancado>`
- **Props:** `icon={Truck}, colorVariant="emerald", value="96.2%", description="entregas no prazo", chartData=[...]`

**9. Performance IA**
- **M√©trica:** Precis√£o dos modelos de IA (%)
- **Fonte:** `GET /api/dashboard/ia-performance`
- **Update:** 1 hora
- **Componente:** `<MiniCardAvancado>`
- **Props:** `icon={Cpu}, colorVariant="purple", value="97.3%", description="precis√£o do sistema", chartData=[...]`

**10. NFe Pendentes**
- **M√©trica:** Notas fiscais n√£o emitidas
- **Fonte:** `GET /api/dashboard/nfe-pendentes`
- **Update:** 5 minutos
- **Componente:** `<Badge>` dentro de lista
- **A√ß√£o:** Click abre modal de emiss√£o

**11. Compliance Score**
- **M√©trica:** Percentual de conformidade geral
- **Fonte:** `GET /api/dashboard/compliance-score`
- **Update:** 1 hora
- **Componente:** `<Progress>` com percentual
- **Cores:** Verde (>90%), Amarelo (70-89%), Vermelho (<70%)

#### B. A√ß√µes R√°pidas (8 bot√µes)

**1. Nova Cirurgia**
```tsx
<Button 
  onClick={() => setModalCirurgia(true)}
  className="bg-icarus-primary"
>
  <Plus size={20} />
  Nova Cirurgia
</Button>
```
- **A√ß√£o:** Abre `<DialogNovaCirurgia>`
- **Componente:** Modal full-screen
- **Submit:** POST `/api/cirurgias/nova`

**2. Adicionar Produto**
- **A√ß√£o:** Abre `<DialogNovoProduto>`
- **Componente:** Modal m√©dio
- **Submit:** POST `/api/produtos-opme`

**3. Emitir NFe**
- **A√ß√£o:** Abre `<DialogEmitirNFe>`
- **Componente:** Modal large
- **Submit:** POST `/api/faturamento/nfe/emitir`

**4. Registrar Compra**
- **A√ß√£o:** Abre `<DialogNovaCompra>`
- **Componente:** Modal large
- **Submit:** POST `/api/compras/registrar`

**5. Lan√ßar Pagamento**
- **A√ß√£o:** Abre `<DialogLancarPagamento>`
- **Componente:** Modal m√©dio
- **Submit:** POST `/api/financeiro/pagamentos/lancar`

**6. Enviar Consigna√ß√£o**
- **A√ß√£o:** Abre `<DialogNovaConsignacao>`
- **Componente:** Modal full-screen
- **Submit:** POST `/api/consignacao/enviar`

**7. Cadastrar Hospital**
- **A√ß√£o:** Abre `<DialogNovoHospital>`
- **Componente:** Modal large
- **Submit:** POST `/api/hospitais`

**8. Ver Relat√≥rios**
- **A√ß√£o:** Redirect para `/relatorios-executivos`
- **Componente:** Button secondary
- **Icon:** `FileBarChart`

#### C. Alertas e Notifica√ß√µes

**Componente:** `<NotificationCenter>`
- **Localiza√ß√£o:** Topbar (canto superior direito)
- **√çcone:** `Bell` com badge de contagem
- **Fonte:** WebSocket + Polling (30s)
- **API:** `GET /api/notificacoes/recentes`

**Tipos de Alertas:**
1. **Cr√≠tico** (vermelho) - Estoque zerado, NFe rejeitada
2. **Aviso** (laranja) - Prazo pr√≥ximo, estoque baixo
3. **Info** (azul) - Nova cirurgia agendada, pagamento recebido
4. **Sucesso** (verde) - Processo conclu√≠do

**Exemplo:**
```tsx
<Badge variant="destructive">
  <AlertTriangle size={14} />
  Produto XYZ com estoque zerado
</Badge>
```

#### D. Navega√ß√£o R√°pida

**Grid de M√≥dulos:**
```tsx
<div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
  {modulos.map(modulo => (
    <Button
      key={modulo.id}
      variant="outline"
      className="flex flex-col items-center gap-2 h-24"
      onClick={() => navigate(modulo.rota)}
    >
      <modulo.icon size={24} />
      <span className="text-xs">{modulo.nome}</span>
    </Button>
  ))}
</div>
```

**M√≥dulos Exibidos (12):**
1. Estoque IA ‚Üí `Package`
2. Cirurgias ‚Üí `Calendar`
3. Financeiro ‚Üí `DollarSign`
4. CRM ‚Üí `Users`
5. Compras ‚Üí `ShoppingCart`
6. Faturamento ‚Üí `FileText`
7. Log√≠stica ‚Üí `Truck`
8. Compliance ‚Üí `Shield`
9. IA Central ‚Üí `Brain`
10. Relat√≥rios ‚Üí `BarChart`
11. Integra√ß√µes ‚Üí `Plug`
12. Configura√ß√µes ‚Üí `Settings`

### ‚öôÔ∏è Funcionalidades Backend

#### A. APIs REST

**1. GET `/api/dashboard/overview`**
```typescript
Response: {
  kpis: {
    sistemaStatus: { value: "98%", trend: 2.3 },
    medicosAtivos: { value: 1847, trend: 12.5 },
    produtosOPME: { value: "12.4K", trend: 5.2 },
    pedidosUrgentes: { value: 89, trend: -8.1 },
    faturamentoMensal: { 
      value: "R$ 3.8M", 
      secundario: "R$ 127K",
      trend: 15.3 
    },
    // ... outros KPIs
  },
  alertas: [
    {
      id: "alert-001",
      tipo: "critico",
      mensagem: "Produto XYZ com estoque zerado",
      timestamp: "2025-11-23T10:30:00Z"
    }
  ],
  acoes_pendentes: {
    nfe_pendentes: 15,
    cirurgias_hoje: 8,
    pagamentos_hoje: 12
  }
}
```

**2. GET `/api/dashboard/kpi/:nome`**
- **Par√¢metros:** `nome` (sistema-status, medicos-ativos, etc)
- **Response:** Dados detalhados do KPI espec√≠fico
- **Cache:** 5 minutos (Redis)

**3. POST `/api/dashboard/acoes-rapidas/:acao`**
- **Par√¢metros:** `acao` (nova-cirurgia, emitir-nfe, etc)
- **Body:** Dados do formul√°rio
- **Response:** Status da opera√ß√£o + ID criado

**4. GET `/api/dashboard/notificacoes`**
```typescript
Response: {
  total: 15,
  nao_lidas: 5,
  notificacoes: [
    {
      id: "notif-001",
      tipo: "critico",
      titulo: "Estoque Cr√≠tico",
      mensagem: "Produto ABC est√° com estoque zerado",
      timestamp: "2025-11-23T10:30:00Z",
      lida: false,
      acao: {
        label: "Ver Produto",
        url: "/estoque/produtos/abc"
      }
    }
  ]
}
```

**5. PUT `/api/dashboard/notificacoes/:id/ler`**
- **Fun√ß√£o:** Marcar notifica√ß√£o como lida
- **Response:** `{ success: true }`

#### B. WebSockets (Tempo Real)

**Namespace:** `/dashboard`

**Eventos Emitidos pelo Servidor:**
```typescript
// 1. Atualiza√ß√£o de KPI
socket.emit('kpi:update', {
  nome: 'sistema-status',
  value: '99%',
  trend: 3.1,
  timestamp: Date.now()
});

// 2. Novo Alerta
socket.emit('alerta:novo', {
  id: 'alert-002',
  tipo: 'aviso',
  mensagem: 'NFe 12345 pendente de autoriza√ß√£o',
  timestamp: Date.now()
});

// 3. A√ß√£o Conclu√≠da
socket.emit('acao:concluida', {
  acao: 'nova-cirurgia',
  id: 'cirurgia-456',
  status: 'sucesso'
});
```

**Eventos Recebidos do Cliente:**
```typescript
// 1. Solicitar Atualiza√ß√£o
socket.on('dashboard:refresh', () => {
  // Envia dados atualizados
});

// 2. Marcar Notifica√ß√£o como Lida
socket.on('notificacao:ler', (id: string) => {
  // Atualiza no banco
});
```

#### C. Banco de Dados (Supabase)

**Tabelas Utilizadas:**

**1. dashboard_kpis**
```sql
CREATE TABLE dashboard_kpis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  nome VARCHAR(100) UNIQUE NOT NULL,
  valor_atual DECIMAL,
  valor_anterior DECIMAL,
  trend DECIMAL,
  unidade VARCHAR(10),
  ultima_atualizacao TIMESTAMP DEFAULT NOW(),
  configuracao JSONB,
  ativo BOOLEAN DEFAULT TRUE
);
```

**2. dashboard_acoes_rapidas**
```sql
CREATE TABLE dashboard_acoes_rapidas (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  usuario_id UUID REFERENCES usuarios(id),
  acao VARCHAR(100) NOT NULL,
  dados JSONB,
  status VARCHAR(20),
  criado_em TIMESTAMP DEFAULT NOW(),
  concluido_em TIMESTAMP
);
```

**3. dashboard_alertas**
```sql
CREATE TABLE dashboard_alertas (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tipo VARCHAR(20) NOT NULL,
  titulo VARCHAR(200) NOT NULL,
  mensagem TEXT,
  origem VARCHAR(100),
  severidade INTEGER,
  lido BOOLEAN DEFAULT FALSE,
  lido_em TIMESTAMP,
  usuario_id UUID REFERENCES usuarios(id),
  criado_em TIMESTAMP DEFAULT NOW()
);
```

**4. dashboard_configuracoes**
```sql
CREATE TABLE dashboard_configuracoes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  usuario_id UUID REFERENCES usuarios(id),
  layout JSONB,
  kpis_visiveis JSONB,
  refresh_interval INTEGER DEFAULT 300,
  atualizado_em TIMESTAMP DEFAULT NOW()
);
```

#### D. Integra√ß√µes Externas

**1. Sistema de Notifica√ß√µes**
- **Servi√ßo:** Firebase Cloud Messaging (FCM)
- **Fun√ß√£o:** Push notifications para app mobile
- **Trigger:** Alertas cr√≠ticos

**2. Analytics**
- **Servi√ßo:** Google Analytics 4
- **Fun√ß√£o:** Tracking de uso do dashboard
- **Eventos:** KPI visualizado, a√ß√£o r√°pida clicada

**3. Logs**
- **Servi√ßo:** Sentry
- **Fun√ß√£o:** Monitoramento de erros
- **Contexto:** KPI que falhou, dados do usu√°rio

### üîå Integra√ß√µes Internas

**M√≥dulos Conectados (15):**
1. Estoque IA ‚Üí KPI "Estoque Cr√≠tico"
2. Cirurgias ‚Üí KPI "Cirurgias do M√™s", A√ß√£o "Nova Cirurgia"
3. Financeiro ‚Üí KPI "Faturamento Mensal", "Contas a Receber"
4. Faturamento NFe ‚Üí KPI "NFe Pendentes", A√ß√£o "Emitir NFe"
5. Consigna√ß√£o ‚Üí KPI "Consigna√ß√µes Ativas", A√ß√£o "Enviar Consigna√ß√£o"
6. CRM ‚Üí KPI "Hospitais Ativos", "M√©dicos Ativos"
7. Compras ‚Üí A√ß√£o "Registrar Compra"
8. Log√≠stica ‚Üí KPI "Performance de Entrega"
9. Compliance ‚Üí KPI "Compliance Score"
10. IA Central ‚Üí KPI "Performance IA"
11. Produtos OPME ‚Üí A√ß√£o "Adicionar Produto"
12. Hospitais ‚Üí A√ß√£o "Cadastrar Hospital"
13. Notifica√ß√µes ‚Üí Central de alertas
14. Relat√≥rios ‚Üí A√ß√£o "Ver Relat√≥rios"
15. Configura√ß√µes ‚Üí Layout personalizado

### üìä M√©tricas de Performance

**Carregamento:**
- First Paint: < 1s
- Time to Interactive: < 2s
- KPIs carregados: < 3s (com cache)

**Atualiza√ß√µes:**
- WebSocket latency: < 100ms
- Polling interval: 30s-5min (configur√°vel)
- Cache TTL: 5-30min (por KPI)

**Volume:**
- Suporta at√© 50 KPIs simult√¢neos
- M√°ximo 100 notifica√ß√µes em mem√≥ria
- 1000 usu√°rios simult√¢neos

---

## 02. KPI DASHBOARD CONSOLIDADO

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `KPIDashboardConsolidado.tsx` |
| **√çcone** | `BarChart3` (Lucide React) |
| **Rota** | `/kpi-dashboard` |
| **Permiss√£o** | `kpi.view, kpi.manage` |
| **Categoria** | Dashboard & Analytics |
| **Status** | ‚úÖ Implementado 100% |
| **Prioridade** | Alta |

### üéØ Descri√ß√£o

Dashboard especializado em KPIs com visualiza√ß√µes avan√ßadas, compara√ß√µes temporais, drill-downs e exporta√ß√£o de relat√≥rios. Permite criar, editar e gerenciar KPIs customizados para diferentes √°reas do neg√≥cio.

### üìã Sub-M√≥dulos (5)

1. **KPIs Operacionais** - M√©tricas de opera√ß√£o di√°ria
2. **KPIs Financeiros** - Indicadores financeiros
3. **KPIs de Qualidade** - M√©tricas de qualidade e conformidade
4. **KPIs Customizados** - Indicadores criados por usu√°rios
5. **Comparativos** - An√°lise comparativa entre per√≠odos

### üìù Formul√°rios (2)

#### 1. Criar KPI Customizado
- **Campos:** Nome, Descri√ß√£o, F√≥rmula, Fonte de Dados, Meta, Visualiza√ß√£o
- **Valida√ß√£o:** F√≥rmula v√°lida (parsing), fonte de dados existente
- **Submit:** POST `/api/kpis/criar`
- **Success:** KPI dispon√≠vel no dashboard

#### 2. Configurar Alertas de KPI
- **Campos:** KPI, Condi√ß√£o (>, <, =), Valor Limite, Destinat√°rios, Frequ√™ncia
- **Valida√ß√£o:** Destinat√°rios v√°lidos, valor num√©rico
- **Submit:** POST `/api/kpis/:id/alertas`
- **Success:** Alerta configurado

### üé® Componentes Utilizados

**Gr√°ficos (Recharts):**
- `LineChart` (12x) - Tend√™ncias temporais
- `BarChart` (8x) - Compara√ß√µes
- `PieChart` (4x) - Distribui√ß√µes
- `AreaChart` (6x) - √Åreas cumulativas
- `RadarChart` (2x) - Compara√ß√£o multi-dimensional
- `ComposedChart` (3x) - Combina√ß√£o de tipos

**Componentes Customizados:**
- `KPICard` (25x) - Card especializado para KPI
- `KPIComparisonTable` (4x) - Tabela comparativa
- `TrendIndicator` (25x) - Seta de tend√™ncia
- `SparklineChart` (15x) - Gr√°fico miniatura
- `GoalProgress` (10x) - Progresso em rela√ß√£o √† meta

**Componentes UI:**
- `Tabs` (1x) - Navega√ß√£o entre categorias
- `Select` (8x) - Filtros (per√≠odo, √°rea, tipo)
- `DateRangePicker` (4x) - Sele√ß√£o de per√≠odo
- `Tooltip` (40x) - Informa√ß√µes adicionais
- `Sheet` (2x) - Pain√©is laterais

**√çcones (Lucide React):**
- `TrendingUp` - Tend√™ncia positiva
- `TrendingDown` - Tend√™ncia negativa
- `Target` - Meta
- `Calendar` - Per√≠odo
- `Filter` - Filtros
- `Download` - Exportar
- `Plus` - Adicionar KPI
- `Settings` - Configura√ß√µes
- `Bell` - Alertas
- `RefreshCw` - Atualizar

### üîß Funcionalidades Frontend

#### A. KPIs Operacionais (10 cards)

**1. Taxa de Ocupa√ß√£o de Estoque**
- **F√≥rmula:** `(Estoque Atual / Capacidade M√°xima) * 100`
- **Meta:** 80%
- **Visualiza√ß√£o:** Gauge Chart
- **Fonte:** `GET /api/kpis/estoque/ocupacao`
- **Update:** 30 minutos

**2. Tempo M√©dio de Entrega**
- **F√≥rmula:** `AVG(Data Entrega - Data Pedido)`
- **Meta:** ‚â§ 3 dias
- **Visualiza√ß√£o:** Line Chart (√∫ltimos 30 dias)
- **Fonte:** `GET /api/kpis/logistica/tempo-entrega`
- **Update:** 1 hora

**3. Taxa de Ruptura**
- **F√≥rmula:** `(Produtos Zerados / Total Produtos) * 100`
- **Meta:** ‚â§ 2%
- **Visualiza√ß√£o:** Bar Chart + Sparkline
- **Fonte:** `GET /api/kpis/estoque/ruptura`
- **Update:** 15 minutos

**4. Produtividade de Vendedores**
- **F√≥rmula:** `Faturamento Total / N√∫mero de Vendedores`
- **Meta:** R$ 150.000/m√™s/vendedor
- **Visualiza√ß√£o:** Ranking Bar Chart
- **Fonte:** `GET /api/kpis/vendas/produtividade`
- **Update:** 1 hora

**5. Taxa de Convers√£o de Leads**
- **F√≥rmula:** `(Leads Convertidos / Total Leads) * 100`
- **Meta:** ‚â• 15%
- **Visualiza√ß√£o:** Funnel Chart
- **Fonte:** `GET /api/kpis/crm/conversao`
- **Update:** 1 hora

**6. Cirurgias Canceladas**
- **F√≥rmula:** `(Cirurgias Canceladas / Total Agendadas) * 100`
- **Meta:** ‚â§ 5%
- **Visualiza√ß√£o:** Pie Chart + Line Chart (tend√™ncia)
- **Fonte:** `GET /api/kpis/cirurgias/cancelamentos`
- **Update:** 1 hora

**7. Tempo M√©dio de Atendimento (CRM)**
- **F√≥rmula:** `AVG(Tempo Fim - Tempo In√≠cio)`
- **Meta:** ‚â§ 15 minutos
- **Visualiza√ß√£o:** Box Plot (distribui√ß√£o)
- **Fonte:** `GET /api/kpis/crm/tempo-atendimento`
- **Update:** 30 minutos

**8. Taxa de Devolu√ß√£o**
- **F√≥rmula:** `(Produtos Devolvidos / Total Vendidos) * 100`
- **Meta:** ‚â§ 1%
- **Visualiza√ß√£o:** Area Chart (√∫ltimos 90 dias)
- **Fonte:** `GET /api/kpis/vendas/devolucao`
- **Update:** 1 hora

**9. Utiliza√ß√£o de Consigna√ß√£o**
- **F√≥rmula:** `(Kits Utilizados / Kits Enviados) * 100`
- **Meta:** ‚â• 70%
- **Visualiza√ß√£o:** Gauge + Map (geogr√°fico)
- **Fonte:** `GET /api/kpis/consignacao/utilizacao`
- **Update:** 2 horas

**10. Efici√™ncia de Compras**
- **F√≥rmula:** `(Compras no Prazo / Total Compras) * 100`
- **Meta:** ‚â• 95%
- **Visualiza√ß√£o:** Progress Bar + Trend
- **Fonte:** `GET /api/kpis/compras/eficiencia`
- **Update:** 1 hora

#### B. KPIs Financeiros (10 cards)

**1. Margem de Lucro**
- **F√≥rmula:** `((Receita - Custos) / Receita) * 100`
- **Meta:** ‚â• 25%
- **Visualiza√ß√£o:** Line Chart + Comparativo
- **Fonte:** `GET /api/kpis/financeiro/margem-lucro`
- **Update:** Di√°rio

**2. ROI (Return on Investment)**
- **F√≥rmula:** `((Lucro - Investimento) / Investimento) * 100`
- **Meta:** ‚â• 15%
- **Visualiza√ß√£o:** Bar Chart (por categoria)
- **Fonte:** `GET /api/kpis/financeiro/roi`
- **Update:** Mensal

**3. √çndice de Inadimpl√™ncia**
- **F√≥rmula:** `(T√≠tulos Vencidos / Total T√≠tulos) * 100`
- **Meta:** ‚â§ 3%
- **Visualiza√ß√£o:** Waterfall Chart
- **Fonte:** `GET /api/kpis/financeiro/inadimplencia`
- **Update:** Di√°rio

**4. Ciclo Financeiro**
- **F√≥rmula:** `PMR + PME - PMP` (Prazo M√©dio Recebimento + Estocagem - Pagamento)
- **Meta:** ‚â§ 45 dias
- **Visualiza√ß√£o:** Timeline Chart
- **Fonte:** `GET /api/kpis/financeiro/ciclo`
- **Update:** Semanal

**5. Ticket M√©dio**
- **F√≥rmula:** `Faturamento Total / N√∫mero de Vendas`
- **Meta:** R$ 50.000
- **Visualiza√ß√£o:** Histogram + Trend
- **Fonte:** `GET /api/kpis/financeiro/ticket-medio`
- **Update:** Di√°rio

**6. Capital de Giro**
- **F√≥rmula:** `Ativo Circulante - Passivo Circulante`
- **Meta:** > R$ 2.000.000
- **Visualiza√ß√£o:** Area Chart (proje√ß√£o)
- **Fonte:** `GET /api/kpis/financeiro/capital-giro`
- **Update:** Di√°rio

**7. EBITDA**
- **F√≥rmula:** `Lucro Operacional + Deprecia√ß√£o + Amortiza√ß√£o`
- **Meta:** > R$ 500.000/m√™s
- **Visualiza√ß√£o:** Bar Chart + Comparativo
- **Fonte:** `GET /api/kpis/financeiro/ebitda`
- **Update:** Mensal

**8. Custo de Aquisi√ß√£o de Cliente (CAC)**
- **F√≥rmula:** `Total Investimento Marketing / Novos Clientes`
- **Meta:** ‚â§ R$ 5.000
- **Visualiza√ß√£o:** Line Chart + Cohort
- **Fonte:** `GET /api/kpis/financeiro/cac`
- **Update:** Mensal

**9. Lifetime Value (LTV)**
- **F√≥rmula:** `(Ticket M√©dio * Freq. Compra * Tempo Vida) - CAC`
- **Meta:** ‚â• R$ 150.000
- **Visualiza√ß√£o:** Cohort Analysis
- **Fonte:** `GET /api/kpis/financeiro/ltv`
- **Update:** Mensal

**10. Fluxo de Caixa Operacional**
- **F√≥rmula:** `Receitas Operacionais - Despesas Operacionais`
- **Meta:** Positivo
- **Visualiza√ß√£o:** Waterfall Chart
- **Fonte:** `GET /api/kpis/financeiro/fluxo-caixa`
- **Update:** Di√°rio

#### C. KPIs de Qualidade (5 cards)

**1. √çndice de Conformidade ANVISA**
- **F√≥rmula:** `(Produtos Conformes / Total Produtos) * 100`
- **Meta:** 100%
- **Visualiza√ß√£o:** Gauge + Detalhe por categoria
- **Fonte:** `GET /api/kpis/qualidade/conformidade-anvisa`
- **Update:** Di√°rio

**2. Taxa de N√£o Conformidades**
- **F√≥rmula:** `(N√£o Conformidades Abertas / Auditorias Realizadas) * 100`
- **Meta:** ‚â§ 5%
- **Visualiza√ß√£o:** Pareto Chart
- **Fonte:** `GET /api/kpis/qualidade/nao-conformidades`
- **Update:** Semanal

**3. Tempo M√©dio de Resolu√ß√£o de NC**
- **F√≥rmula:** `AVG(Data Fechamento - Data Abertura)`
- **Meta:** ‚â§ 7 dias
- **Visualiza√ß√£o:** Box Plot
- **Fonte:** `GET /api/kpis/qualidade/tempo-resolucao`
- **Update:** Di√°rio

**4. Certifica√ß√µes V√°lidas**
- **F√≥rmula:** `(Certifica√ß√µes Vigentes / Total Necess√°rias) * 100`
- **Meta:** 100%
- **Visualiza√ß√£o:** Status Grid + Timeline
- **Fonte:** `GET /api/kpis/qualidade/certificacoes`
- **Update:** Di√°rio

**5. Score de Qualidade Total**
- **F√≥rmula:** M√©dia ponderada de todos os KPIs de qualidade
- **Meta:** ‚â• 95
- **Visualiza√ß√£o:** Radar Chart
- **Fonte:** `GET /api/kpis/qualidade/score-total`
- **Update:** Di√°rio

#### D. Funcionalidades Avan√ßadas

**1. Comparativo Temporal**
```tsx
<div className="space-y-4">
  <div className="flex gap-3">
    <DateRangePicker
      label="Per√≠odo 1"
      value={periodo1}
      onChange={setPeriodo1}
    />
    <DateRangePicker
      label="Per√≠odo 2"
      value={periodo2}
      onChange={setPeriodo2}
    />
  </div>
  
  <KPIComparisonTable
    kpis={selectedKPIs}
    periodo1={periodo1}
    periodo2={periodo2}
  />
</div>
```

**2. Drill-Down**
- Click no KPI abre detalhamento
- Visualiza√ß√£o hier√°rquica (empresa ‚Üí √°rea ‚Üí equipe ‚Üí indiv√≠duo)
- Breadcrumb de navega√ß√£o
- Bot√£o "Voltar" para n√≠vel anterior

**3. Alertas Configur√°veis**
```tsx
<Dialog>
  <DialogTrigger>
    <Button variant="outline">
      <Bell size={16} />
      Configurar Alerta
    </Button>
  </DialogTrigger>
  <DialogContent>
    <FormAlertaKPI
      kpi={selectedKPI}
      onSubmit={handleSaveAlerta}
    />
  </DialogContent>
</Dialog>
```

**4. Exporta√ß√£o de Relat√≥rios**
```tsx
<DropdownMenu>
  <DropdownMenuTrigger>
    <Button>
      <Download size={16} />
      Exportar
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent>
    <DropdownMenuItem onClick={() => exportPDF()}>
      PDF
    </DropdownMenuItem>
    <DropdownMenuItem onClick={() => exportExcel()}>
      Excel
    </DropdownMenuItem>
    <DropdownMenuItem onClick={() => exportPowerPoint()}>
      PowerPoint
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

**5. Filtros Avan√ßados**
```tsx
<div className="flex gap-3">
  <Select value={areaFilter} onValueChange={setAreaFilter}>
    <SelectTrigger>√Årea</SelectTrigger>
    <SelectContent>
      <SelectItem value="todas">Todas</SelectItem>
      <SelectItem value="vendas">Vendas</SelectItem>
      <SelectItem value="estoque">Estoque</SelectItem>
      <SelectItem value="financeiro">Financeiro</SelectItem>
    </SelectContent>
  </Select>
  
  <Select value={periodoFilter} onValueChange={setPeriodoFilter}>
    <SelectTrigger>Per√≠odo</SelectTrigger>
    <SelectContent>
      <SelectItem value="dia">Hoje</SelectItem>
      <SelectItem value="semana">√öltimos 7 dias</SelectItem>
      <SelectItem value="mes">√öltimos 30 dias</SelectItem>
      <SelectItem value="trimestre">√öltimo trimestre</SelectItem>
      <SelectItem value="ano">√öltimo ano</SelectItem>
    </SelectContent>
  </Select>
  
  <Button variant="outline" onClick={resetFilters}>
    Limpar Filtros
  </Button>
</div>
```

### ‚öôÔ∏è Funcionalidades Backend

#### A. APIs REST

**1. GET `/api/kpis/lista`**
```typescript
Query Params: {
  area?: string,
  tipo?: 'operacional' | 'financeiro' | 'qualidade' | 'customizado',
  ativo?: boolean,
  usuario_id?: string
}

Response: {
  kpis: [
    {
      id: "kpi-001",
      nome: "Taxa de Ocupa√ß√£o de Estoque",
      descricao: "...",
      formula: "(estoque_atual / capacidade_maxima) * 100",
      area: "estoque",
      tipo: "operacional",
      meta: 80,
      valor_atual: 75.5,
      valor_anterior: 72.3,
      trend: 4.4,
      ultima_atualizacao: "2025-11-23T10:30:00Z",
      visualizacao: "gauge",
      configuracao: {...}
    }
  ]
}
```

**2. POST `/api/kpis/criar`**
```typescript
Body: {
  nome: string,
  descricao: string,
  formula: string,
  fonte_dados: string,
  meta: number,
  visualizacao: 'line' | 'bar' | 'pie' | 'gauge',
  area: string,
  frequencia_atualizacao: number
}

Response: {
  id: "kpi-new-001",
  status: "criado",
  proxima_atualizacao: "2025-11-23T11:00:00Z"
}
```

**3. GET `/api/kpis/:id/historico`**
```typescript
Query Params: {
  data_inicio: string,
  data_fim: string,
  granularidade: 'hora' | 'dia' | 'semana' | 'mes'
}

Response: {
  kpi_id: "kpi-001",
  historico: [
    {
      timestamp: "2025-11-01T00:00:00Z",
      valor: 72.5,
      meta: 80
    },
    {
      timestamp: "2025-11-02T00:00:00Z",
      valor: 73.8,
      meta: 80
    }
  ]
}
```

**4. GET `/api/kpis/:id/drill-down`**
```typescript
Query Params: {
  nivel: 'empresa' | 'area' | 'equipe' | 'individuo',
  entidade_id?: string
}

Response: {
  kpi_id: "kpi-001",
  nivel: "area",
  dados: [
    {
      entidade_id: "area-vendas",
      entidade_nome: "Vendas",
      valor: 85.5,
      meta: 80,
      trend: 5.2,
      filhos: [...]
    }
  ]
}
```

**5. POST `/api/kpis/:id/alertas`**
```typescript
Body: {
  condicao: '>' | '<' | '=' | '>=' | '<=',
  valor_limite: number,
  destinatarios: string[],
  frequencia: 'imediato' | 'diario' | 'semanal',
  ativo: boolean
}

Response: {
  alerta_id: "alerta-001",
  status: "configurado"
}
```

**6. GET `/api/kpis/comparativo`**
```typescript
Query Params: {
  kpi_ids: string[],
  periodo1_inicio: string,
  periodo1_fim: string,
  periodo2_inicio: string,
  periodo2_fim: string
}

Response: {
  comparacao: [
    {
      kpi_id: "kpi-001",
      periodo1: { valor: 75.5, media: 72.3 },
      periodo2: { valor: 80.2, media: 78.1 },
      variacao: 6.2,
      variacao_percentual: 7.9
    }
  ]
}
```

**7. POST `/api/kpis/exportar`**
```typescript
Body: {
  kpi_ids: string[],
  formato: 'pdf' | 'excel' | 'powerpoint',
  periodo_inicio: string,
  periodo_fim: string,
  incluir_graficos: boolean,
  incluir_drill_down: boolean
}

Response: {
  arquivo_url: "https://storage.icarus.com/exports/kpi-report-001.pdf",
  expira_em: "2025-11-24T10:30:00Z"
}
```

#### B. C√°lculo de KPIs (Background Jobs)

**Job: `calcular_kpis`**
- **Frequ√™ncia:** Configur√°vel por KPI (5min - 1 dia)
- **Executor:** Node.js Cron Job + Bull Queue
- **Processo:**

```typescript
async function calcularKPI(kpi_id: string) {
  // 1. Buscar configura√ß√£o do KPI
  const kpi = await db.kpis.findUnique({ where: { id: kpi_id } });
  
  // 2. Executar query na fonte de dados
  const fonte = kpi.fonte_dados; // ex: "tabela_vendas"
  const formula = kpi.formula; // ex: "SUM(valor) / COUNT(*)"
  
  const resultado = await db.raw(`
    SELECT ${formula} as valor
    FROM ${fonte}
    WHERE data >= NOW() - INTERVAL '${kpi.janela_tempo}'
  `);
  
  // 3. Comparar com per√≠odo anterior
  const valor_anterior = await db.kpi_historico.findFirst({
    where: { kpi_id },
    orderBy: { timestamp: 'desc' },
    skip: 1
  });
  
  const trend = calcularTrend(resultado.valor, valor_anterior?.valor);
  
  // 4. Salvar no hist√≥rico
  await db.kpi_historico.create({
    data: {
      kpi_id,
      valor: resultado.valor,
      timestamp: new Date()
    }
  });
  
  // 5. Atualizar cache (Redis)
  await redis.set(`kpi:${kpi_id}:atual`, JSON.stringify({
    valor: resultado.valor,
    trend,
    timestamp: new Date()
  }), 'EX', kpi.cache_ttl);
  
  // 6. Verificar alertas
  await verificarAlertasKPI(kpi_id, resultado.valor);
  
  // 7. Emitir evento WebSocket
  io.emit('kpi:atualizado', {
    kpi_id,
    valor: resultado.valor,
    trend
  });
}
```

**Verifica√ß√£o de Alertas:**
```typescript
async function verificarAlertasKPI(kpi_id: string, valor: number) {
  const alertas = await db.kpi_alertas.findMany({
    where: { kpi_id, ativo: true }
  });
  
  for (const alerta of alertas) {
    const condicaoAtendida = avaliarCondicao(
      valor,
      alerta.condicao,
      alerta.valor_limite
    );
    
    if (condicaoAtendida) {
      // Enviar notifica√ß√£o
      await enviarAlerta({
        destinatarios: alerta.destinatarios,
        titulo: `Alerta de KPI: ${kpi.nome}`,
        mensagem: `O KPI "${kpi.nome}" atingiu ${valor}, ${alerta.condicao} ${alerta.valor_limite}`,
        tipo: 'aviso',
        link: `/kpi-dashboard?kpi=${kpi_id}`
      });
      
      // Registrar ocorr√™ncia
      await db.kpi_alertas_historico.create({
        data: {
          alerta_id: alerta.id,
          valor_kpi: valor,
          timestamp: new Date()
        }
      });
    }
  }
}
```

#### C. Banco de Dados (Supabase)

**Tabelas:**

**1. kpis**
```sql
CREATE TABLE kpis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  nome VARCHAR(200) NOT NULL,
  descricao TEXT,
  formula TEXT NOT NULL,
  fonte_dados VARCHAR(100) NOT NULL,
  area VARCHAR(50),
  tipo VARCHAR(20) CHECK (tipo IN ('operacional', 'financeiro', 'qualidade', 'customizado')),
  meta DECIMAL,
  visualizacao VARCHAR(20) DEFAULT 'line',
  frequencia_atualizacao INTEGER DEFAULT 3600,
  janela_tempo VARCHAR(50) DEFAULT '30 days',
  cache_ttl INTEGER DEFAULT 300,
  ativo BOOLEAN DEFAULT TRUE,
  criado_por UUID REFERENCES usuarios(id),
  criado_em TIMESTAMP DEFAULT NOW(),
  configuracao JSONB
);
```

**2. kpi_historico**
```sql
CREATE TABLE kpi_historico (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  kpi_id UUID REFERENCES kpis(id) ON DELETE CASCADE,
  valor DECIMAL NOT NULL,
  timestamp TIMESTAMP NOT NULL,
  metadados JSONB,
  INDEX idx_kpi_timestamp (kpi_id, timestamp DESC)
);
```

**3. kpi_alertas**
```sql
CREATE TABLE kpi_alertas (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  kpi_id UUID REFERENCES kpis(id) ON DELETE CASCADE,
  condicao VARCHAR(10) NOT NULL,
  valor_limite DECIMAL NOT NULL,
  destinatarios TEXT[] NOT NULL,
  frequencia VARCHAR(20) DEFAULT 'imediato',
  ativo BOOLEAN DEFAULT TRUE,
  criado_em TIMESTAMP DEFAULT NOW(),
  ultima_verificacao TIMESTAMP
);
```

**4. kpi_alertas_historico**
```sql
CREATE TABLE kpi_alertas_historico (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  alerta_id UUID REFERENCES kpi_alertas(id),
  valor_kpi DECIMAL NOT NULL,
  timestamp TIMESTAMP DEFAULT NOW(),
  notificacao_enviada BOOLEAN DEFAULT FALSE
);
```

**5. kpi_drill_down**
```sql
CREATE TABLE kpi_drill_down (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  kpi_id UUID REFERENCES kpis(id),
  nivel VARCHAR(20) NOT NULL,
  entidade_id VARCHAR(100) NOT NULL,
  entidade_nome VARCHAR(200),
  valor DECIMAL NOT NULL,
  timestamp TIMESTAMP NOT NULL,
  INDEX idx_drill_down (kpi_id, nivel, timestamp DESC)
);
```

#### D. Integra√ß√µes Externas

**1. Microsoft Power BI**
- **Fun√ß√£o:** Export de KPIs para dashboards Power BI
- **API:** Power BI REST API
- **M√©todo:** POST para dataset
- **Frequ√™ncia:** 1 hora

**2. Google Data Studio**
- **Fun√ß√£o:** Visualiza√ß√µes alternativas
- **API:** Google Sheets API (intermedi√°rio)
- **M√©todo:** Append rows
- **Frequ√™ncia:** 30 minutos

**3. Slack**
- **Fun√ß√£o:** Alertas de KPI em canais
- **API:** Slack Web API
- **M√©todo:** POST `/chat.postMessage`
- **Trigger:** Alerta configurado

**4. Email (SendGrid)**
- **Fun√ß√£o:** Relat√≥rios di√°rios/semanais
- **Template:** HTML com gr√°ficos embarcados
- **Frequ√™ncia:** Configur√°vel por usu√°rio

### üîå Integra√ß√µes Internas

**M√≥dulos Conectados (20):**
1. Dashboard Principal ‚Üí Compartilha KPIs
2. Estoque IA ‚Üí KPIs de estoque
3. Financeiro ‚Üí KPIs financeiros
4. Vendas/CRM ‚Üí KPIs de vendas
5. Cirurgias ‚Üí KPIs de procedimentos
6. Log√≠stica ‚Üí KPIs de entrega
7. Compras ‚Üí KPIs de aquisi√ß√£o
8. Qualidade ‚Üí KPIs de conformidade
9. Consigna√ß√£o ‚Üí KPIs de utiliza√ß√£o
10. RH ‚Üí KPIs de produtividade
11. Compliance ‚Üí KPIs regulat√≥rios
12. Faturamento ‚Üí KPIs de emiss√£o
13. Relat√≥rios ‚Üí Fonte de dados
14. IA Central ‚Üí Predi√ß√µes de KPIs
15. Notifica√ß√µes ‚Üí Alertas de limite
16. Configura√ß√µes ‚Üí Personaliza√ß√£o
17. Auditoria ‚Üí Log de mudan√ßas
18. Integrations Manager ‚Üí Export de dados
19. API Gateway ‚Üí Acesso externo
20. Analytics ‚Üí Tracking de uso

### üìä M√©tricas de Performance

**C√°lculo:**
- KPI simples: < 500ms
- KPI complexo (drill-down): < 2s
- KPI com hist√≥rico (1 ano): < 5s

**Armazenamento:**
- Hist√≥rico: 2 anos (compactado)
- Cache: 5-30 min (Redis)
- √çndices: Timestamp + KPI ID

**Volume:**
- Suporta at√© 500 KPIs ativos
- 1M+ registros de hist√≥rico
- 10.000 c√°lculos/hora

---

## 03. ANALYTICS BI

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `AnalyticsBINovo.tsx` |
| **√çcone** | `Brain` (Lucide React) |
| **Rota** | `/analytics-bi` |
| **Permiss√£o** | `analytics.view, bi.manage` |
| **Categoria** | Dashboard & Analytics |
| **Status** | ‚úÖ Implementado 100% |
| **Prioridade** | Alta |

### üéØ Descri√ß√£o

M√≥dulo avan√ßado de Business Intelligence com an√°lises preditivas, machine learning integrado, correla√ß√µes autom√°ticas e insights acion√°veis. Conecta-se a m√∫ltiplas fontes de dados e gera relat√≥rios inteligentes.

### üìã Sub-M√≥dulos (6)

1. **An√°lise Explorat√≥ria** - Visualiza√ß√µes interativas e filtros din√¢micos
2. **An√°lise Preditiva** - Forecasting e tend√™ncias
3. **Correla√ß√µes** - Identifica√ß√£o de padr√µes e rela√ß√µes
4. **Segmenta√ß√£o** - Clustering e agrupamento de dados
5. **Anomalias** - Detec√ß√£o de outliers e comportamentos at√≠picos
6. **Insights Autom√°ticos** - Descobertas geradas por IA

### üìù Formul√°rios (3)

#### 1. Criar An√°lise Customizada
- **Campos:** Nome, Fonte de Dados, Dimens√µes, M√©tricas, Filtros, Tipo de Visualiza√ß√£o
- **Valida√ß√£o:** Dimens√µes e m√©tricas compat√≠veis
- **Submit:** POST `/api/analytics/criar-analise`
- **Success:** An√°lise salva e dispon√≠vel

#### 2. Agendar Relat√≥rio
- **Campos:** An√°lise, Destinat√°rios, Frequ√™ncia (di√°ria/semanal/mensal), Formato, Hora
- **Valida√ß√£o:** Email v√°lido, frequ√™ncia compat√≠vel
- **Submit:** POST `/api/analytics/agendar-relatorio`
- **Success:** Relat√≥rio agendado

#### 3. Configurar Alerta de Anomalia
- **Campos:** M√©trica, Sensibilidade (baixa/m√©dia/alta), A√ß√£o (notificar/email), Destinat√°rios
- **Valida√ß√£o:** M√©trica num√©rica, destinat√°rios v√°lidos
- **Submit:** POST `/api/analytics/alertas-anomalia`
- **Success:** Alerta configurado

### üé® Componentes Utilizados

**Gr√°ficos Avan√ßados (Recharts + D3.js):**
- `ScatterChart` (6x) - An√°lise de correla√ß√£o
- `HeatMap` (3x) - Matriz de correla√ß√£o
- `SankeyDiagram` (2x) - Fluxos de dados
- `TreeMap` (3x) - Hierarquias
- `BoxPlot` (4x) - Distribui√ß√µes estat√≠sticas
- `BubbleChart` (3x) - 3 dimens√µes
- `ViolinPlot` (2x) - Densidades

**Componentes Customizados:**
- `InteractiveChart` (15x) - Gr√°fico com brush e zoom
- `StatisticsCard` (12x) - Card com estat√≠sticas descritivas
- `CorrelationMatrix` (2x) - Matriz interativa
- `PredictionChart` (4x) - Forecast com intervalo de confian√ßa
- `AnomalyDetector` (3x) - Visualiza√ß√£o de outliers
- `InsightCard` (20x) - Card com descoberta autom√°tica

**Componentes UI:**
- `Tabs` (3x) - Navega√ß√£o entre an√°lises
- `MultiSelect` (8x) - Sele√ß√£o de dimens√µes/m√©tricas
- `Slider` (6x) - Ajuste de par√¢metros
- `Switch` (10x) - Toggle de op√ß√µes
- `Accordion` (5x) - Filtros colaps√°veis

**√çcones (Lucide React):**
- `Brain` - IA/ML
- `TrendingUp` - Previs√µes
- `Zap` - Insights
- `AlertCircle` - Anomalias
- `Link` - Correla√ß√µes
- `Layers` - Segmenta√ß√£o
- `Eye` - Visualiza√ß√£o
- `Download` - Exportar
- `Calendar` - Agendar
- `Settings` - Configura√ß√µes

### üîß Funcionalidades Frontend

#### A. An√°lise Explorat√≥ria

**1. Seletor de Fonte de Dados**
```tsx
<Select value={fonteAtual} onValueChange={setFonteAtual}>
  <SelectTrigger>Fonte de Dados</SelectTrigger>
  <SelectContent>
    <SelectItem value="vendas">Vendas</SelectItem>
    <SelectItem value="estoque">Estoque</SelectItem>
    <SelectItem value="cirurgias">Cirurgias</SelectItem>
    <SelectItem value="financeiro">Financeiro</SelectItem>
    <SelectItem value="custom">Consulta Customizada</SelectItem>
  </SelectContent>
</Select>
```

**2. Construtor de Visualiza√ß√£o Drag-and-Drop**
```tsx
<div className="grid grid-cols-3 gap-4">
  {/* Painel de Campos */}
  <Card className="col-span-1">
    <CardHeader>Campos Dispon√≠veis</CardHeader>
    <CardContent>
      <DraggableList items={campos} />
    </CardContent>
  </Card>
  
  {/* √Årea de Drop: Dimens√µes */}
  <Card className="col-span-1">
    <CardHeader>Dimens√µes (Eixo X)</CardHeader>
    <CardContent>
      <DroppableArea
        onDrop={(item) => setDimensoes([...dimensoes, item])}
      />
    </CardContent>
  </Card>
  
  {/* √Årea de Drop: M√©tricas */}
  <Card className="col-span-1">
    <CardHeader>M√©tricas (Eixo Y)</CardHeader>
    <CardContent>
      <DroppableArea
        onDrop={(item) => setMetricas([...metricas, item])}
      />
    </CardContent>
  </Card>
</div>
```

**3. Painel de Filtros Din√¢micos**
```tsx
<Accordion type="multiple">
  {filtrosDisponiveis.map(filtro => (
    <AccordionItem key={filtro.id} value={filtro.id}>
      <AccordionTrigger>{filtro.label}</AccordionTrigger>
      <AccordionContent>
        {filtro.tipo === 'range' && (
          <Slider
            min={filtro.min}
            max={filtro.max}
            value={filtro.value}
            onValueChange={(v) => updateFiltro(filtro.id, v)}
          />
        )}
        {filtro.tipo === 'multiselect' && (
          <MultiSelect
            options={filtro.opcoes}
            value={filtro.selecionados}
            onChange={(v) => updateFiltro(filtro.id, v)}
          />
        )}
        {filtro.tipo === 'date' && (
          <DateRangePicker
            value={filtro.range}
            onChange={(v) => updateFiltro(filtro.id, v)}
          />
        )}
      </AccordionContent>
    </AccordionItem>
  ))}
</Accordion>
```

**4. Gr√°fico Interativo com Brush e Zoom**
```tsx
<InteractiveChart>
  <ResponsiveContainer width="100%" height={400}>
    <LineChart data={data}>
      <CartesianGrid strokeDasharray="3 3" />
      <XAxis dataKey="data" />
      <YAxis />
      <Tooltip content={<CustomTooltip />} />
      <Legend />
      
      {metricas.map(metrica => (
        <Line
          key={metrica.id}
          type="monotone"
          dataKey={metrica.campo}
          stroke={metrica.cor}
          strokeWidth={2}
        />
      ))}
      
      {/* Brush para zoom temporal */}
      <Brush
        dataKey="data"
        height={30}
        stroke="#6366F1"
      />
    </LineChart>
  </ResponsiveContainer>
</InteractiveChart>
```

#### B. An√°lise Preditiva

**1. Forecast com Intervalo de Confian√ßa**
```tsx
<PredictionChart>
  <ResponsiveContainer width="100%" height={400}>
    <LineChart data={historico.concat(previsao)}>
      <CartesianGrid strokeDasharray="3 3" />
      <XAxis dataKey="data" />
      <YAxis />
      <Tooltip />
      <Legend />
      
      {/* Linha de dados hist√≥ricos */}
      <Line
        type="monotone"
        dataKey="valor"
        stroke="#6366F1"
        strokeWidth={2}
        dot={{ r: 3 }}
      />
      
      {/* Linha de previs√£o */}
      <Line
        type="monotone"
        dataKey="previsao"
        stroke="#10B981"
        strokeWidth={2}
        strokeDasharray="5 5"
        dot={{ r: 3 }}
      />
      
      {/* √Årea de confian√ßa (95%) */}
      <Area
        type="monotone"
        dataKey="intervalo_superior"
        stroke="none"
        fill="#10B981"
        fillOpacity={0.2}
      />
      <Area
        type="monotone"
        dataKey="intervalo_inferior"
        stroke="none"
        fill="#10B981"
        fillOpacity={0.2}
      />
    </LineChart>
  </ResponsiveContainer>
</PredictionChart>
```

**2. Seletor de Modelo Preditivo**
```tsx
<Select value={modeloAtual} onValueChange={setModeloAtual}>
  <SelectTrigger>Modelo Preditivo</SelectTrigger>
  <SelectContent>
    <SelectItem value="arima">ARIMA (Auto-Regressivo)</SelectItem>
    <SelectItem value="prophet">Prophet (Facebook)</SelectItem>
    <SelectItem value="lstm">LSTM (Rede Neural)</SelectItem>
    <SelectItem value="xgboost">XGBoost (Gradient Boosting)</SelectItem>
    <SelectItem value="ensemble">Ensemble (M√∫ltiplos Modelos)</SelectItem>
  </SelectContent>
</Select>
```

**3. Par√¢metros de Previs√£o**
```tsx
<div className="space-y-4">
  <div>
    <Label>Horizonte de Previs√£o</Label>
    <Slider
      min={7}
      max={365}
      value={[horizonte]}
      onValueChange={([v]) => setHorizonte(v)}
    />
    <span className="text-sm text-muted-foreground">{horizonte} dias</span>
  </div>
  
  <div>
    <Label>Intervalo de Confian√ßa</Label>
    <Slider
      min={50}
      max={99}
      value={[confianca]}
      onValueChange={([v]) => setConfianca(v)}
    />
    <span className="text-sm text-muted-foreground">{confianca}%</span>
  </div>
  
  <div className="flex items-center gap-2">
    <Switch
      checked={incluirSazonalidade}
      onCheckedChange={setIncluirSazonalidade}
    />
    <Label>Incluir Sazonalidade</Label>
  </div>
</div>
```

**4. Estat√≠sticas do Modelo**
```tsx
<StatisticsCard>
  <div className="grid grid-cols-2 gap-4">
    <div>
      <span className="text-sm text-muted-foreground">MAE</span>
      <p className="text-2xl font-semibold">{modelo.mae.toFixed(2)}</p>
    </div>
    <div>
      <span className="text-sm text-muted-foreground">RMSE</span>
      <p className="text-2xl font-semibold">{modelo.rmse.toFixed(2)}</p>
    </div>
    <div>
      <span className="text-sm text-muted-foreground">MAPE</span>
      <p className="text-2xl font-semibold">{modelo.mape.toFixed(1)}%</p>
    </div>
    <div>
      <span className="text-sm text-muted-foreground">R¬≤</span>
      <p className="text-2xl font-semibold">{modelo.r2.toFixed(3)}</p>
    </div>
  </div>
</StatisticsCard>
```

#### C. An√°lise de Correla√ß√µes

**1. Matriz de Correla√ß√£o Interativa**
```tsx
<CorrelationMatrix>
  <HeatMap
    data={matrizCorrelacao}
    width={600}
    height={600}
    xAxis={variaveis}
    yAxis={variaveis}
    colorScale={['#EF4444', '#FFFFFF', '#10B981']}
    minValue={-1}
    maxValue={1}
    onCellClick={(x, y, value) => {
      setSelectedPair([x, y]);
      setShowDetailModal(true);
    }}
  />
</CorrelationMatrix>
```

**2. Scatter Plot com Linha de Regress√£o**
```tsx
<ScatterChart width={600} height={400} data={dados}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey={variavel1} label={variavel1Label} />
  <YAxis dataKey={variavel2} label={variavel2Label} />
  <Tooltip cursor={{ strokeDasharray: '3 3' }} />
  
  {/* Pontos */}
  <Scatter
    name="Dados"
    data={dados}
    fill="#6366F1"
  />
  
  {/* Linha de regress√£o */}
  <Line
    type="monotone"
    dataKey="regressao"
    stroke="#EF4444"
    strokeWidth={2}
    dot={false}
  />
</ScatterChart>
```

**3. Detalhamento de Correla√ß√£o**
```tsx
<Dialog open={showDetailModal} onOpenChange={setShowDetailModal}>
  <DialogContent className="max-w-4xl">
    <DialogHeader>
      <DialogTitle>
        Correla√ß√£o: {selectedPair[0]} √ó {selectedPair[1]}
      </DialogTitle>
    </DialogHeader>
    
    <div className="space-y-4">
      <StatisticsCard>
        <div className="grid grid-cols-3 gap-4">
          <div>
            <span className="text-sm">Correla√ß√£o de Pearson</span>
            <p className="text-2xl font-semibold">
              {correlacao.pearson.toFixed(3)}
            </p>
          </div>
          <div>
            <span className="text-sm">P-value</span>
            <p className="text-2xl font-semibold">
              {correlacao.pvalue.toFixed(4)}
            </p>
          </div>
          <div>
            <span className="text-sm">Signific√¢ncia</span>
            <Badge variant={correlacao.pvalue < 0.05 ? 'default' : 'secondary'}>
              {correlacao.pvalue < 0.05 ? 'Significativa' : 'N√£o Significativa'}
            </Badge>
          </div>
        </div>
      </StatisticsCard>
      
      <ScatterPlot data={detailedData} />
      
      <div className="p-4 bg-blue-50 rounded-md">
        <p className="text-sm">
          <strong>Interpreta√ß√£o:</strong> {interpretacaoCorrelacao}
        </p>
      </div>
    </div>
  </DialogContent>
</Dialog>
```

#### D. Segmenta√ß√£o (Clustering)

**1. Sele√ß√£o de Algoritmo**
```tsx
<Select value={algoritmo} onValueChange={setAlgoritmo}>
  <SelectTrigger>Algoritmo de Clustering</SelectTrigger>
  <SelectContent>
    <SelectItem value="kmeans">K-Means</SelectItem>
    <SelectItem value="dbscan">DBSCAN</SelectItem>
    <SelectItem value="hierarchical">Hier√°rquico</SelectItem>
    <SelectItem value="gmm">Gaussian Mixture</SelectItem>
  </SelectContent>
</Select>
```

**2. Visualiza√ß√£o de Clusters**
```tsx
<ScatterChart width={800} height={600} data={dadosComClusters}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey="dimensao1" label="Dimens√£o 1 (PCA)" />
  <YAxis dataKey="dimensao2" label="Dimens√£o 2 (PCA)" />
  <Tooltip />
  <Legend />
  
  {clusters.map(cluster => (
    <Scatter
      key={cluster.id}
      name={cluster.nome}
      data={cluster.pontos}
      fill={cluster.cor}
    />
  ))}
</ScatterChart>
```

**3. Perfil dos Clusters**
```tsx
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
  {clusters.map(cluster => (
    <Card key={cluster.id}>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <div
            className="w-4 h-4 rounded-full"
            style={{ backgroundColor: cluster.cor }}
          />
          {cluster.nome}
        </CardTitle>
        <CardDescription>
          {cluster.tamanho} registros ({cluster.percentual}%)
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-2">
          {cluster.caracteristicas.map(carac => (
            <div key={carac.nome}>
              <div className="flex justify-between text-sm">
                <span>{carac.nome}</span>
                <span className="font-medium">{carac.valor}</span>
              </div>
              <Progress value={carac.intensidade} className="h-2" />
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  ))}
</div>
```

#### E. Detec√ß√£o de Anomalias

**1. Configura√ß√£o de Sensibilidade**
```tsx
<div className="space-y-4">
  <Label>Sensibilidade de Detec√ß√£o</Label>
  <RadioGroup value={sensibilidade} onValueChange={setSensibilidade}>
    <div className="flex items-center space-x-2">
      <RadioGroupItem value="baixa" id="baixa" />
      <Label htmlFor="baixa">
        Baixa (apenas outliers extremos)
      </Label>
    </div>
    <div className="flex items-center space-x-2">
      <RadioGroupItem value="media" id="media" />
      <Label htmlFor="media">
        M√©dia (outliers moderados e extremos)
      </Label>
    </div>
    <div className="flex items-center space-x-2">
      <RadioGroupItem value="alta" id="alta" />
      <Label htmlFor="alta">
        Alta (detectar pequenos desvios)
      </Label>
    </div>
  </RadioGroup>
</div>
```

**2. Visualiza√ß√£o de Anomalias**
```tsx
<LineChart width={800} height={400} data={dados}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey="data" />
  <YAxis />
  <Tooltip />
  <Legend />
  
  {/* Linha normal */}
  <Line
    type="monotone"
    dataKey="valor"
    stroke="#6366F1"
    strokeWidth={2}
  />
  
  {/* Banda de normalidade */}
  <Area
    type="monotone"
    dataKey="limite_superior"
    stroke="none"
    fill="#10B981"
    fillOpacity={0.1}
  />
  <Area
    type="monotone"
    dataKey="limite_inferior"
    stroke="none"
    fill="#10B981"
    fillOpacity={0.1}
  />
  
  {/* Anomalias destacadas */}
  <Scatter
    name="Anomalias"
    data={anomalias}
    fill="#EF4444"
    shape="star"
  />
</LineChart>
```

**3. Lista de Anomalias Detectadas**
```tsx
<div className="space-y-2">
  {anomalias.map(anomalia => (
    <Card key={anomalia.id}>
      <CardContent className="p-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <AlertCircle className="text-red-500" size={20} />
            <div>
              <p className="font-medium">{anomalia.descricao}</p>
              <p className="text-sm text-muted-foreground">
                {format(new Date(anomalia.data), 'dd/MM/yyyy HH:mm')}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <Badge variant="destructive">
              Desvio: {anomalia.desvio_padrao.toFixed(1)}œÉ
            </Badge>
            <Button variant="outline" size="sm">
              Investigar
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  ))}
</div>
```

#### F. Insights Autom√°ticos

**1. Card de Insight Gerado por IA**
```tsx
<InsightCard>
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <Zap className="text-yellow-500" size={20} />
      Insight Descoberto
    </CardTitle>
    <CardDescription>
      Gerado automaticamente em {insight.timestamp}
    </CardDescription>
  </CardHeader>
  <CardContent>
    <p className="text-sm mb-4">{insight.descricao}</p>
    
    <div className="grid grid-cols-2 gap-4 mb-4">
      <div>
        <span className="text-sm text-muted-foreground">Confian√ßa</span>
        <div className="flex items-center gap-2">
          <Progress value={insight.confianca * 100} className="flex-1" />
          <span className="text-sm font-medium">
            {(insight.confianca * 100).toFixed(0)}%
          </span>
        </div>
      </div>
      <div>
        <span className="text-sm text-muted-foreground">Impacto</span>
        <Badge
          variant={
            insight.impacto === 'alto' ? 'default' :
            insight.impacto === 'medio' ? 'secondary' : 'outline'
          }
        >
          {insight.impacto}
        </Badge>
      </div>
    </div>
    
    {insight.recomendacao && (
      <div className="p-3 bg-blue-50 rounded-md">
        <p className="text-sm">
          <strong>Recomenda√ß√£o:</strong> {insight.recomendacao}
        </p>
      </div>
    )}
    
    <div className="flex gap-2 mt-4">
      <Button size="sm" onClick={() => aplicarRecomendacao(insight.id)}>
        Aplicar Recomenda√ß√£o
      </Button>
      <Button size="sm" variant="outline">
        Ver Detalhes
      </Button>
      <Button size="sm" variant="ghost">
        Descartar
      </Button>
    </div>
  </CardContent>
</InsightCard>
```

**2. Categorias de Insights**
```tsx
<Tabs value={categoriaAtiva} onValueChange={setCategoriaAtiva}>
  <TabsList>
    <TabsTrigger value="vendas">
      <TrendingUp size={16} className="mr-2" />
      Vendas ({insights.vendas.length})
    </TabsTrigger>
    <TabsTrigger value="estoque">
      <Package size={16} className="mr-2" />
      Estoque ({insights.estoque.length})
    </TabsTrigger>
    <TabsTrigger value="financeiro">
      <DollarSign size={16} className="mr-2" />
      Financeiro ({insights.financeiro.length})
    </TabsTrigger>
    <TabsTrigger value="operacional">
      <Activity size={16} className="mr-2" />
      Operacional ({insights.operacional.length})
    </TabsTrigger>
  </TabsList>
  
  <TabsContent value={categoriaAtiva}>
    <div className="space-y-3">
      {insights[categoriaAtiva].map(insight => (
        <InsightCard key={insight.id} insight={insight} />
      ))}
    </div>
  </TabsContent>
</Tabs>
```

### ‚öôÔ∏è Funcionalidades Backend

#### A. APIs REST

**1. GET `/api/analytics/fontes-dados`**
```typescript
Response: {
  fontes: [
    {
      id: "vendas",
      nome: "Vendas",
      tabela: "vendas",
      campos: [
        { nome: "data_venda", tipo: "date", label: "Data" },
        { nome: "valor_total", tipo: "decimal", label: "Valor" },
        { nome: "cliente_id", tipo: "uuid", label: "Cliente" },
        { nome: "vendedor_id", tipo: "uuid", label: "Vendedor" }
      ],
      registros: 15420
    }
  ]
}
```

**2. POST `/api/analytics/executar-analise`**
```typescript
Body: {
  fonte: string,
  dimensoes: string[],
  metricas: Array<{
    campo: string,
    agregacao: 'sum' | 'avg' | 'count' | 'min' | 'max'
  }>,
  filtros: Array<{
    campo: string,
    operador: '=' | '>' | '<' | 'in' | 'between',
    valor: any
  }>,
  ordenacao: { campo: string, direcao: 'asc' | 'desc' }
}

Response: {
  dados: [...],
  estatisticas: {
    total_registros: number,
    tempo_execucao_ms: number,
    cache_hit: boolean
  }
}
```

**3. POST `/api/analytics/previsao`**
```typescript
Body: {
  fonte: string,
  campo_target: string,
  campo_tempo: string,
  modelo: 'arima' | 'prophet' | 'lstm' | 'xgboost' | 'ensemble',
  horizonte_dias: number,
  intervalo_confianca: number,
  incluir_sazonalidade: boolean
}

Response: {
  previsao: [
    {
      data: "2025-11-24",
      valor_previsto: 125000,
      intervalo_inferior: 110000,
      intervalo_superior: 140000
    }
  ],
  metricas_modelo: {
    mae: 5420.32,
    rmse: 7821.54,
    mape: 4.2,
    r2: 0.923
  },
  modelo_treinado_id: "modelo-001"
}
```

**4. POST `/api/analytics/correlacoes`**
```typescript
Body: {
  fonte: string,
  variaveis: string[],
  metodo: 'pearson' | 'spearman' | 'kendall'
}

Response: {
  matriz: [
    [1.0, 0.85, 0.32],
    [0.85, 1.0, 0.41],
    [0.32, 0.41, 1.0]
  ],
  pvalues: [...],
  interpretacoes: [
    {
      variavel1: "vendas",
      variavel2: "marketing",
      correlacao: 0.85,
      significancia: true,
      interpretacao: "Forte correla√ß√£o positiva entre investimento em marketing e vendas"
    }
  ]
}
```

**5. POST `/api/analytics/clustering`**
```typescript
Body: {
  fonte: string,
  variaveis: string[],
  algoritmo: 'kmeans' | 'dbscan' | 'hierarchical' | 'gmm',
  n_clusters?: number,
  parametros?: object
}

Response: {
  clusters: [
    {
      id: 1,
      nome: "Cluster 1",
      tamanho: 350,
      percentual: 23.5,
      centroide: [...],
      caracteristicas: [...]
    }
  ],
  metricas: {
    silhouette_score: 0.72,
    davies_bouldin_index: 0.45,
    calinski_harabasz_score: 1245.32
  }
}
```

**6. POST `/api/analytics/anomalias`**
```typescript
Body: {
  fonte: string,
  campo: string,
  sensibilidade: 'baixa' | 'media' | 'alta',
  algoritmo: 'zscore' | 'iqr' | 'isolation_forest' | 'autoencoder'
}

Response: {
  anomalias: [
    {
      id: "anomalia-001",
      data: "2025-11-15T14:30:00Z",
      valor: 250000,
      valor_esperado: 125000,
      desvio_padrao: 3.5,
      severidade: "alta",
      probabilidade_anomalia: 0.95
    }
  ],
  estatisticas: {
    total_anomalias: 12,
    percentual: 0.08,
    falsos_positivos_estimados: 1
  }
}
```

**7. GET `/api/analytics/insights`**
```typescript
Query Params: {
  categoria?: 'vendas' | 'estoque' | 'financeiro' | 'operacional',
  min_confianca?: number,
  min_impacto?: 'baixo' | 'medio' | 'alto'
}

Response: {
  insights: [
    {
      id: "insight-001",
      categoria: "vendas",
      titulo: "Oportunidade de Upsell",
      descricao: "Clientes que compraram produto A t√™m 78% de chance de comprar produto B",
      confianca: 0.85,
      impacto: "alto",
      recomendacao: "Criar campanha de cross-sell para produto B",
      dados_suporte: {...},
      timestamp: "2025-11-23T10:30:00Z"
    }
  ]
}
```

#### B. Machine Learning (Python microservice)

**Servi√ßo:** Python Flask/FastAPI  
**Bibliotecas:** scikit-learn, statsmodels, Prophet, TensorFlow

**Endpoint: POST `/ml/forecast`**
```python
@app.route('/ml/forecast', methods=['POST'])
def generate_forecast():
    data = request.json
    modelo = data['modelo']
    dados_historicos = pd.DataFrame(data['dados'])
    horizonte = data['horizonte_dias']
    
    if modelo == 'prophet':
        # Facebook Prophet
        from prophet import Prophet
        m = Prophet(
            yearly_seasonality=True,
            weekly_seasonality=True,
            interval_width=data['intervalo_confianca'] / 100
        )
        m.fit(dados_historicos.rename(columns={'data': 'ds', 'valor': 'y'}))
        
        future = m.make_future_dataframe(periods=horizonte)
        forecast = m.predict(future)
        
        # M√©tricas
        mae = mean_absolute_error(dados_historicos['y'], forecast['yhat'][:len(dados_historicos)])
        
        return jsonify({
            'previsao': forecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']].tail(horizonte).to_dict('records'),
            'metricas': {
                'mae': mae,
                'rmse': np.sqrt(mean_squared_error(...)),
                'mape': mean_absolute_percentage_error(...),
                'r2': r2_score(...)
            }
        })
    
    elif modelo == 'lstm':
        # Rede Neural LSTM
        from tensorflow.keras.models import Sequential
        from tensorflow.keras.layers import LSTM, Dense
        
        # Preparar dados
        X_train, y_train = prepare_sequences(dados_historicos)
        
        # Criar modelo
        model = Sequential([
            LSTM(50, activation='relu', input_shape=(X_train.shape[1], 1)),
            Dense(1)
        ])
        model.compile(optimizer='adam', loss='mse')
        
        # Treinar
        model.fit(X_train, y_train, epochs=50, verbose=0)
        
        # Prever
        previsoes = []
        for i in range(horizonte):
            pred = model.predict(...)
            previsoes.append(pred)
        
        return jsonify({
            'previsao': previsoes,
            'metricas': {...}
        })
```

**Endpoint: POST `/ml/clustering`**
```python
@app.route('/ml/clustering', methods=['POST'])
def perform_clustering():
    data = request.json
    dados = pd.DataFrame(data['dados'])
    algoritmo = data['algoritmo']
    
    # Normalizar dados
    from sklearn.preprocessing import StandardScaler
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(dados[data['variaveis']])
    
    if algoritmo == 'kmeans':
        from sklearn.cluster import KMeans
        kmeans = KMeans(n_clusters=data['n_clusters'], random_state=42)
        labels = kmeans.fit_predict(X_scaled)
        
        # M√©tricas
        from sklearn.metrics import silhouette_score, davies_bouldin_score
        silhouette = silhouette_score(X_scaled, labels)
        db_score = davies_bouldin_score(X_scaled, labels)
        
        # Criar perfis de clusters
        clusters = []
        for i in range(data['n_clusters']):
            cluster_data = dados[labels == i]
            perfil = cluster_data[data['variaveis']].describe()
            
            clusters.append({
                'id': i,
                'nome': f'Cluster {i+1}',
                'tamanho': len(cluster_data),
                'percentual': len(cluster_data) / len(dados) * 100,
                'centroide': kmeans.cluster_centers_[i].tolist(),
                'caracteristicas': perfil.to_dict()
            })
        
        return jsonify({
            'clusters': clusters,
            'metricas': {
                'silhouette_score': silhouette,
                'davies_bouldin_index': db_score
            }
        })
```

**Endpoint: POST `/ml/anomalias`**
```python
@app.route('/ml/anomalias', methods=['POST'])
def detect_anomalies():
    data = request.json
    dados = np.array(data['dados'])
    algoritmo = data['algoritmo']
    sensibilidade = data['sensibilidade']
    
    # Mapear sensibilidade para threshold
    thresholds = {'baixa': 3, 'media': 2, 'alta': 1.5}
    threshold = thresholds[sensibilidade]
    
    if algoritmo == 'zscore':
        # Z-Score method
        mean = np.mean(dados)
        std = np.std(dados)
        z_scores = np.abs((dados - mean) / std)
        
        anomalias_idx = np.where(z_scores > threshold)[0]
        
        anomalias = []
        for idx in anomalias_idx:
            anomalias.append({
                'indice': int(idx),
                'valor': float(dados[idx]),
                'valor_esperado': float(mean),
                'desvio_padrao': float(z_scores[idx]),
                'severidade': 'alta' if z_scores[idx] > 3 else 'media',
                'probabilidade_anomalia': float(1 - norm.cdf(z_scores[idx]))
            })
        
        return jsonify({
            'anomalias': anomalias,
            'estatisticas': {
                'total_anomalias': len(anomalias),
                'percentual': len(anomalias) / len(dados) * 100
            }
        })
    
    elif algoritmo == 'isolation_forest':
        from sklearn.ensemble import IsolationForest
        
        clf = IsolationForest(contamination='auto', random_state=42)
        labels = clf.fit_predict(dados.reshape(-1, 1))
        
        # -1 = anomalia, 1 = normal
        anomalias_idx = np.where(labels == -1)[0]
        
        # ... processar anomalias
```

#### C. Banco de Dados (Supabase)

**Tabelas:**

**1. analytics_analises**
```sql
CREATE TABLE analytics_analises (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  nome VARCHAR(200) NOT NULL,
  descricao TEXT,
  fonte_dados VARCHAR(100) NOT NULL,
  dimensoes JSONB NOT NULL,
  metricas JSONB NOT NULL,
  filtros JSONB,
  tipo_visualizacao VARCHAR(50) DEFAULT 'line',
  usuario_id UUID REFERENCES usuarios(id),
  criado_em TIMESTAMP DEFAULT NOW(),
  atualizado_em TIMESTAMP,
  ultima_execucao TIMESTAMP,
  configuracao JSONB
);
```

**2. analytics_previsoes**
```sql
CREATE TABLE analytics_previsoes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  analise_id UUID REFERENCES analytics_analises(id),
  modelo VARCHAR(50) NOT NULL,
  campo_target VARCHAR(100) NOT NULL,
  horizonte_dias INTEGER NOT NULL,
  dados_previsao JSONB NOT NULL,
  metricas_modelo JSONB NOT NULL,
  criado_em TIMESTAMP DEFAULT NOW(),
  valido_ate TIMESTAMP,
  acuracia_real DECIMAL
);
```

**3. analytics_insights**
```sql
CREATE TABLE analytics_insights (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  categoria VARCHAR(50) NOT NULL,
  titulo VARCHAR(200) NOT NULL,
  descricao TEXT NOT NULL,
  confianca DECIMAL NOT NULL CHECK (confianca BETWEEN 0 AND 1),
  impacto VARCHAR(20) CHECK (impacto IN ('baixo', 'medio', 'alto')),
  recomendacao TEXT,
  dados_suporte JSONB,
  status VARCHAR(20) DEFAULT 'novo',
  lido BOOLEAN DEFAULT FALSE,
  aplicado BOOLEAN DEFAULT FALSE,
  criado_em TIMESTAMP DEFAULT NOW(),
  aplicado_em TIMESTAMP
);
```

**4. analytics_anomalias**
```sql
CREATE TABLE analytics_anomalias (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fonte VARCHAR(100) NOT NULL,
  campo VARCHAR(100) NOT NULL,
  data_anomalia TIMESTAMP NOT NULL,
  valor DECIMAL NOT NULL,
  valor_esperado DECIMAL,
  desvio_padrao DECIMAL,
  severidade VARCHAR(20),
  probabilidade DECIMAL,
  investigada BOOLEAN DEFAULT FALSE,
  causa TEXT,
  criado_em TIMESTAMP DEFAULT NOW()
);
```

**5. analytics_relatorios_agendados**
```sql
CREATE TABLE analytics_relatorios_agendados (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  analise_id UUID REFERENCES analytics_analises(id),
  destinatarios TEXT[] NOT NULL,
  frequencia VARCHAR(20) NOT NULL,
  proxima_execucao TIMESTAMP NOT NULL,
  formato VARCHAR(10) DEFAULT 'pdf',
  ativo BOOLEAN DEFAULT TRUE,
  criado_em TIMESTAMP DEFAULT NOW(),
  ultima_execucao TIMESTAMP
);
```

#### D. Integra√ß√µes Externas

**1. Python ML Service**
- **URL:** `http://ml-service:8000`
- **Fun√ß√£o:** Modelos de ML e IA
- **Comunica√ß√£o:** REST API
- **Deploy:** Docker container

**2. Apache Spark (Opcional)**
- **Fun√ß√£o:** Processamento de grandes volumes
- **Uso:** An√°lises com > 1M registros
- **Deploy:** Cluster Kubernetes

**3. Jupyter Notebooks**
- **Fun√ß√£o:** An√°lises explorat√≥rias ad-hoc
- **Integra√ß√£o:** API para executar notebooks
- **Storage:** S3/Supabase Storage

**4. Tableau/Power BI**
- **Fun√ß√£o:** Visualiza√ß√µes externas
- **M√©todo:** Export de dados via API
- **Frequ√™ncia:** Di√°ria

### üîå Integra√ß√µes Internas

**M√≥dulos Conectados (25):**
1. Dashboard Principal ‚Üí Insights autom√°ticos
2. KPI Dashboard ‚Üí An√°lises de KPIs
3. Estoque ‚Üí Previs√£o de demanda
4. Vendas ‚Üí An√°lise de padr√µes
5. Financeiro ‚Üí Forecast financeiro
6. Cirurgias ‚Üí An√°lise de convers√£o
7. CRM ‚Üí Segmenta√ß√£o de clientes
8. Compras ‚Üí Otimiza√ß√£o de pedidos
9. Log√≠stica ‚Üí Previs√£o de rotas
10. Qualidade ‚Üí Detec√ß√£o de n√£o conformidades
11. RH ‚Üí An√°lise de produtividade
12. Marketing ‚Üí ROI de campanhas
13. Faturamento ‚Üí Previs√£o de receita
14. Compliance ‚Üí Risk scoring
15. Consigna√ß√£o ‚Üí Taxa de utiliza√ß√£o
16. Produtos OPME ‚Üí An√°lise de portf√≥lio
17. Hospitais ‚Üí Clustering de perfis
18. M√©dicos ‚Üí An√°lise de comportamento
19. Fornecedores ‚Üí Scoring de performance
20. Transportadoras ‚Üí Efici√™ncia log√≠stica
21. Relat√≥rios ‚Üí Fonte de dados
22. IA Central ‚Üí Compartilha modelos
23. Notifica√ß√µes ‚Üí Alertas de insights
24. API Gateway ‚Üí Export de an√°lises
25. Configura√ß√µes ‚Üí Personaliza√ß√£o

### üìä M√©tricas de Performance

**An√°lises:**
- Simples (< 10K registros): < 2s
- M√©dias (10K-100K registros): < 10s
- Complexas (100K-1M registros): < 60s
- Big Data (> 1M registros): Spark/async

**ML:**
- Previs√£o (Prophet): 5-30s
- Clustering (K-Means): 2-10s
- Detec√ß√£o de Anomalias: 1-5s
- LSTM Training: 2-10min (async)

**Cache:**
- An√°lises frequentes: 1 hora
- Previs√µes: 6 horas
- Insights: 30 minutos

---

## 04. ANALYTICS DE PREDI√á√ÉO

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `AnalyticsPredicaoNovo.tsx` |
| **√çcone** | `TrendingUp` (Lucide React) |
| **Rota** | `/analytics-predicao` |
| **Permiss√£o** | `analytics.view, predicao.manage` |
| **Categoria** | Dashboard & Analytics |
| **Status** | ‚úÖ Implementado 100% |
| **Prioridade** | Alta |

### üéØ Descri√ß√£o

M√≥dulo especializado em an√°lises preditivas e forecasting com m√∫ltiplos algoritmos de machine learning, compara√ß√£o de modelos, ajuste autom√°tico de hiperpar√¢metros e valida√ß√£o cruzada.

### üìã Sub-M√≥dulos (4)

1. **Previs√£o de Vendas** - Forecast de receita e volume
2. **Previs√£o de Demanda** - Estoque e produtos OPME
3. **Previs√£o Financeira** - Fluxo de caixa e inadimpl√™ncia
4. **Previs√£o de Churn** - Predi√ß√£o de perda de clientes

### üìù Formul√°rios (2)

#### 1. Configurar Modelo Preditivo
- **Campos:** Nome, Tipo (vendas/demanda/financeiro), Algoritmo, Features, Target, Horizon
- **Valida√ß√£o:** Features num√©ricas, horizon > 0
- **Submit:** POST `/api/predicao/modelos/criar`

#### 2. Treinar Modelo
- **Campos:** Modelo ID, Dataset, Train/Test Split, Cross-Validation Folds
- **Valida√ß√£o:** Dataset v√°lido, split 0-1
- **Submit:** POST `/api/predicao/modelos/:id/treinar`

### üé® Componentes Utilizados

- `ForecastChart` (10x) - Gr√°fico com previs√£o e intervalo
- `ModelComparisonTable` (3x) - Compara√ß√£o de m√©tricas
- `FeatureImportance` (5x) - Import√¢ncia de features
- `ValidationCurve` (4x) - Curva de valida√ß√£o
- `ResidualPlot` (3x) - An√°lise de res√≠duos

**√çcones:**
- `TrendingUp`, `Brain`, `Target`, `Sliders`, `CheckCircle`

### üîß Funcionalidades Frontend

#### A. Dashboard de Modelos

```tsx
<div className="space-y-6">
  {/* Card de cada modelo */}
  {modelos.map(modelo => (
    <Card key={modelo.id}>
      <CardHeader>
        <div className="flex justify-between items-center">
          <div>
            <CardTitle>{modelo.nome}</CardTitle>
            <CardDescription>
              {modelo.algoritmo} ‚Ä¢ √öltima atualiza√ß√£o: {modelo.ultima_atualizacao}
            </CardDescription>
          </div>
          <Badge variant={modelo.status === 'ativo' ? 'default' : 'secondary'}>
            {modelo.status}
          </Badge>
        </div>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-4 gap-4 mb-4">
          <div>
            <span className="text-sm text-muted-foreground">MAE</span>
            <p className="text-2xl font-semibold">{modelo.mae.toFixed(2)}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">RMSE</span>
            <p className="text-2xl font-semibold">{modelo.rmse.toFixed(2)}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">R¬≤</span>
            <p className="text-2xl font-semibold">{modelo.r2.toFixed(3)}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">Acur√°cia</span>
            <p className="text-2xl font-semibold">{(modelo.acuracia * 100).toFixed(1)}%</p>
          </div>
        </div>
        
        <ForecastChart
          historico={modelo.dados_treino}
          previsao={modelo.ultima_previsao}
          intervalo={modelo.intervalo_confianca}
        />
        
        <div className="flex gap-2 mt-4">
          <Button size="sm" onClick={() => executarPrevisao(modelo.id)}>
            <Play size={16} className="mr-2" />
            Executar Previs√£o
          </Button>
          <Button size="sm" variant="outline" onClick={() => retreinarModelo(modelo.id)}>
            <RefreshCw size={16} className="mr-2" />
            Retreinar
          </Button>
          <Button size="sm" variant="outline" onClick={() => verDetalhes(modelo.id)}>
            Ver Detalhes
          </Button>
        </div>
      </CardContent>
    </Card>
  ))}
</div>
```

#### B. Compara√ß√£o de Algoritmos

```tsx
<Tabs defaultValue="metricas">
  <TabsList>
    <TabsTrigger value="metricas">M√©tricas</TabsTrigger>
    <TabsTrigger value="previsoes">Previs√µes</TabsTrigger>
    <TabsTrigger value="features">Features</TabsTrigger>
  </TabsList>
  
  <TabsContent value="metricas">
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Modelo</TableHead>
          <TableHead>Algoritmo</TableHead>
          <TableHead>MAE</TableHead>
          <TableHead>RMSE</TableHead>
          <TableHead>R¬≤</TableHead>
          <TableHead>Tempo Treino</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {comparacao.map(m => (
          <TableRow key={m.id}>
            <TableCell className="font-medium">{m.nome}</TableCell>
            <TableCell>{m.algoritmo}</TableCell>
            <TableCell>{m.mae.toFixed(2)}</TableCell>
            <TableCell>{m.rmse.toFixed(2)}</TableCell>
            <TableCell>{m.r2.toFixed(3)}</TableCell>
            <TableCell>{m.tempo_treino}s</TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  </TabsContent>
</Tabs>
```

### ‚öôÔ∏è Funcionalidades Backend

#### A. APIs REST

**1. GET `/api/predicao/modelos`**
```typescript
Response: {
  modelos: [
    {
      id: "modelo-001",
      nome: "Previs√£o de Vendas - Prophet",
      tipo: "vendas",
      algoritmo: "prophet",
      features: ["mes", "ano", "investimento_marketing"],
      target: "valor_vendas",
      mae: 5420.32,
      rmse: 7821.54,
      r2: 0.923,
      status: "ativo",
      criado_em: "2025-10-01",
      ultima_atualizacao: "2025-11-23"
    }
  ]
}
```

**2. POST `/api/predicao/modelos/:id/prever`**
```typescript
Body: {
  horizonte_dias: number,
  features_futuras?: object
}

Response: {
  previsao: [
    {
      data: "2025-11-24",
      valor: 125000,
      intervalo_inferior: 110000,
      intervalo_superior: 140000
    }
  ],
  confianca: 0.95
}
```

**3. POST `/api/predicao/modelos/:id/retreinar`**
```typescript
Body: {
  novos_dados: [...],
  auto_tune: boolean
}

Response: {
  status: "treinando",
  job_id: "job-001",
  estimativa_conclusao: "2025-11-23T12:00:00Z"
}
```

#### B. Background Jobs

**Job: treinar_modelo_predicao**
```typescript
async function treinarModelo(modelo_id: string) {
  // 1. Buscar configura√ß√£o
  const modelo = await db.modelos_predicao.findUnique({ where: { id: modelo_id } });
  
  // 2. Preparar dados
  const dados = await buscarDadosTreino(modelo.fonte_dados, modelo.features);
  
  // 3. Chamar servi√ßo Python ML
  const response = await fetch('http://ml-service:8000/train', {
    method: 'POST',
    body: JSON.stringify({
      algoritmo: modelo.algoritmo,
      X_train: dados.X,
      y_train: dados.y,
      parametros: modelo.hiperparametros
    })
  });
  
  const resultado = await response.json();
  
  // 4. Salvar m√©tricas
  await db.modelos_predicao.update({
    where: { id: modelo_id },
    data: {
      mae: resultado.metricas.mae,
      rmse: resultado.metricas.rmse,
      r2: resultado.metricas.r2,
      modelo_serializado: resultado.modelo_bytes,
      status: 'ativo'
    }
  });
}
```

### üîå Integra√ß√µes

**Internas:** Dashboard Principal, Analytics BI, Estoque IA, CRM Vendas  
**Externas:** Python ML Service (scikit-learn, Prophet, TensorFlow)

---

## 05. BI DASHBOARD INTERACTIVE

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `BIDashboardInteractive.tsx` |
| **√çcone** | `Layout` (Lucide React) |
| **Rota** | `/bi-dashboard` |
| **Permiss√£o** | `bi.view, bi.edit` |
| **Categoria** | Dashboard & Analytics |
| **Status** | ‚úÖ Implementado 100% |

### üéØ Descri√ß√£o

Dashboard interativo customiz√°vel com drag-and-drop de widgets, filtros globais, drill-through entre visualiza√ß√µes e compartilhamento de dashboards.

### üìã Sub-M√≥dulos (3)

1. **Editor de Dashboard** - Criar e editar layouts
2. **Biblioteca de Widgets** - Widgets pr√©-configurados
3. **Dashboards Compartilhados** - Visualizar dashboards de equipe

### üìù Formul√°rios (2)

#### 1. Criar Dashboard
- **Campos:** Nome, Descri√ß√£o, Visibilidade (privado/equipe/p√∫blico), Layout Inicial
- **Submit:** POST `/api/bi/dashboards/criar`

#### 2. Configurar Widget
- **Campos:** Tipo, Fonte de Dados, Filtros, Visualiza√ß√£o, Tamanho
- **Submit:** POST `/api/bi/widgets/configurar`

### üé® Componentes Utilizados

- `GridLayout` (react-grid-layout) - Layout drag-and-drop
- `WidgetContainer` (50x) - Container de widgets
- `WidgetLibrary` (1x) - Biblioteca de widgets
- `FilterBar` (1x) - Barra de filtros globais
- `ShareDialog` (1x) - Compartilhamento

**√çcones:** `Layout`, `Grid`, `Filter`, `Share2`, `Plus`

### üîß Funcionalidades Frontend

#### A. Grid Layout com Drag-and-Drop

```tsx
import GridLayout from 'react-grid-layout';

const [layout, setLayout] = useState([
  { i: 'widget-1', x: 0, y: 0, w: 6, h: 4 },
  { i: 'widget-2', x: 6, y: 0, w: 6, h: 4 },
]);

<GridLayout
  className="layout"
  layout={layout}
  cols={12}
  rowHeight={30}
  width={1200}
  onLayoutChange={handleLayoutChange}
  isDraggable={editMode}
  isResizable={editMode}
>
  {widgets.map(widget => (
    <div key={widget.id}>
      <WidgetContainer
        widget={widget}
        onRemove={() => removeWidget(widget.id)}
        onConfigure={() => configureWidget(widget.id)}
      />
    </div>
  ))}
</GridLayout>
```

#### B. Biblioteca de Widgets

```tsx
<Sheet>
  <SheetTrigger>
    <Button>
      <Plus size={16} className="mr-2" />
      Adicionar Widget
    </Button>
  </SheetTrigger>
  <SheetContent>
    <SheetHeader>
      <SheetTitle>Biblioteca de Widgets</SheetTitle>
    </SheetHeader>
    
    <div className="space-y-4 mt-4">
      {widgetTemplates.map(template => (
        <Card
          key={template.id}
          className="cursor-pointer hover:border-primary"
          onClick={() => adicionarWidget(template)}
        >
          <CardHeader>
            <CardTitle className="text-sm">{template.nome}</CardTitle>
          </CardHeader>
          <CardContent>
            <template.PreviewComponent />
          </CardContent>
        </Card>
      ))}
    </div>
  </SheetContent>
</Sheet>
```

### ‚öôÔ∏è Funcionalidades Backend

**APIs:**

**1. GET `/api/bi/dashboards/:id`**
```typescript
Response: {
  id: "dash-001",
  nome: "Vendas Executivo",
  layout: [...],
  widgets: [...],
  filtros_globais: {...}
}
```

**2. PUT `/api/bi/dashboards/:id/layout`**
```typescript
Body: { layout: [...] }
Response: { success: true }
```

### üîå Integra√ß√µes

**Internas:** KPI Dashboard, Analytics BI, Todos os m√≥dulos (fonte de dados)

---

## 06. RELAT√ìRIOS EXECUTIVOS

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `RelatoriosExecutivos.tsx` |
| **√çcone** | `FileBarChart` (Lucide React) |
| **Rota** | `/relatorios-executivos` |
| **Permiss√£o** | `relatorios.view` |
| **Categoria** | Dashboard & Analytics |
| **Status** | ‚úÖ Implementado 100% |

### üéØ Descri√ß√£o

Relat√≥rios consolidados para executivos com vis√£o estrat√©gica do neg√≥cio, comparativos entre per√≠odos, an√°lises de rentabilidade e indicadores de crescimento.

### üìã Sub-M√≥dulos (5)

1. **Resumo Executivo** - Vis√£o geral consolidada
2. **An√°lise Financeira** - P&L, Balan√ßo, DFC
3. **An√°lise de Vendas** - Performance comercial
4. **An√°lise Operacional** - Efici√™ncia operacional
5. **Tend√™ncias e Proje√ß√µes** - Forecasts executivos

### üìù Formul√°rios (1)

#### 1. Gerar Relat√≥rio Customizado
- **Campos:** Per√≠odo, M√©tricas, Granularidade, Formato (PDF/Excel/PowerPoint)
- **Submit:** POST `/api/relatorios/gerar`

### üé® Componentes Utilizados

- `ExecutiveSummaryCard` (8x)
- `PLStatement` (1x) - Demonstra√ß√£o de Resultado
- `BalanceSheet` (1x) - Balan√ßo Patrimonial
- `CashFlowStatement` (1x) - Fluxo de Caixa
- `SalesAnalysis` (3x)

### üîß Funcionalidades Frontend

```tsx
<Tabs defaultValue="resumo">
  <TabsList>
    <TabsTrigger value="resumo">Resumo Executivo</TabsTrigger>
    <TabsTrigger value="financeiro">Financeiro</TabsTrigger>
    <TabsTrigger value="vendas">Vendas</TabsTrigger>
    <TabsTrigger value="operacional">Operacional</TabsTrigger>
  </TabsList>
  
  <TabsContent value="resumo">
    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
      <ExecutiveSummaryCard
        titulo="Receita Total"
        valor="R$ 12.5M"
        variacao={15.3}
        periodo="vs m√™s anterior"
      />
      {/* Mais cards... */}
    </div>
  </TabsContent>
</Tabs>
```

### ‚öôÔ∏è Funcionalidades Backend

**APIs:**

**1. GET `/api/relatorios/executivo/resumo`**
```typescript
Query: { periodo_inicio, periodo_fim }
Response: {
  receita_total: 12500000,
  lucro_liquido: 3125000,
  margem_lucro: 25,
  crescimento: 15.3
}
```

**2. POST `/api/relatorios/executivo/exportar`**
```typescript
Body: {
  formato: 'pdf' | 'excel' | 'powerpoint',
  secoes: string[],
  periodo: { inicio, fim }
}
Response: {
  arquivo_url: "https://...",
  expira_em: "2025-11-24T12:00:00Z"
}
```

---

## 07. GEST√ÉO DE CADASTROS

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `Gest√£oCadastros.tsx` |
| **√çcone** | `Users` (Lucide React) |
| **Rota** | `/cadastros` |
| **Permiss√£o** | `cadastros.view, cadastros.edit` |
| **Categoria** | Cadastros & Gest√£o |
| **Status** | ‚úÖ Implementado 100% |

### üéØ Descri√ß√£o

M√≥dulo central para gerenciamento de cadastros: clientes (hospitais), m√©dicos, pacientes, fornecedores e representantes. Valida√ß√£o autom√°tica de documentos, integra√ß√£o com APIs externas e hist√≥rico completo.

### üìã Sub-M√≥dulos (7)

1. **Hospitais/Cl√≠nicas** - Cadastro de clientes
2. **M√©dicos** - Profissionais de sa√∫de
3. **Pacientes** - Pacientes (cirurgias)
4. **Fornecedores** - Fornecedores OPME
5. **Representantes** - Equipe comercial
6. **Transportadoras** - Log√≠stica
7. **Outros Contatos** - Contatos gerais

### üìù Formul√°rios (7)

#### 1. Cadastro de Hospital
- **Campos:** 
  - CNPJ (valida√ß√£o Receita Federal)
  - Raz√£o Social, Nome Fantasia
  - Endere√ßo (autocomplete CEP)
  - Telefone, Email, Website
  - Respons√°vel T√©cnico
  - Tipo (P√∫blico/Privado)
  - Especialidades atendidas
  - Documentos (Alvar√°, CNES, etc)
- **Valida√ß√£o:** CNPJ v√°lido, CNES v√°lido, email √∫nico
- **Submit:** POST `/api/cadastros/hospitais`

#### 2. Cadastro de M√©dico
- **Campos:**
  - CPF (valida√ß√£o)
  - Nome Completo
  - CRM + UF
  - Especialidades (multi-select)
  - Telefone, Email
  - Hospitais Atendidos (multi-select)
  - RQE (Registro de Qualifica√ß√£o de Especialista)
  - Data Nascimento
- **Valida√ß√£o:** CRM v√°lido (API CFM), CPF √∫nico
- **Submit:** POST `/api/cadastros/medicos`

#### 3. Cadastro de Paciente
- **Campos:**
  - CPF ou Cart√£o SUS
  - Nome Completo
  - Data Nascimento, Sexo
  - Telefone, Email
  - Endere√ßo Completo
  - Conv√™nio (se aplic√°vel)
  - Observa√ß√µes M√©dicas
- **Valida√ß√£o:** CPF ou Cart√£o SUS v√°lido
- **Submit:** POST `/api/cadastros/pacientes`

#### 4. Cadastro de Fornecedor
- **Campos:**
  - CNPJ
  - Raz√£o Social, Nome Fantasia
  - Inscri√ß√£o Estadual
  - Endere√ßo
  - Telefone, Email
  - Respons√°vel Comercial
  - Condi√ß√µes de Pagamento
  - Produtos Fornecidos (multi-select)
  - Certifica√ß√µes (ISO, ANVISA)
- **Valida√ß√£o:** CNPJ v√°lido, IE v√°lida
- **Submit:** POST `/api/cadastros/fornecedores`

#### 5. Cadastro de Representante
- **Campos:**
  - CPF
  - Nome Completo
  - Email, Telefone
  - Regi√£o de Atua√ß√£o
  - Comiss√£o (%)
  - Hospitais Atendidos
  - Status (Ativo/Inativo)
- **Valida√ß√£o:** CPF v√°lido, comiss√£o 0-100
- **Submit:** POST `/api/cadastros/representantes`

#### 6. Cadastro de Transportadora
- **Campos:**
  - CNPJ
  - Raz√£o Social
  - ANTT (Ag√™ncia Nacional de Transportes Terrestres)
  - Endere√ßo
  - Telefone, Email
  - Tipos de Ve√≠culo
  - Cobertura (Estados)
  - Tabela de Pre√ßos
- **Valida√ß√£o:** CNPJ e ANTT v√°lidos
- **Submit:** POST `/api/cadastros/transportadoras`

#### 7. Importa√ß√£o em Lote (CSV/Excel)
- **Campos:** Arquivo, Tipo de Cadastro, Mapeamento de Colunas
- **Valida√ß√£o:** Formato v√°lido, colunas obrigat√≥rias presentes
- **Submit:** POST `/api/cadastros/importar`

### üé® Componentes Utilizados

**Tabelas:**
- `DataTable` (7x) - Tabela paginada para cada tipo
- `SearchBar` (7x) - Busca em cada tabela
- `FilterPanel` (7x) - Filtros avan√ßados

**Formul√°rios:**
- `FormularioHospital` (1x)
- `FormularioMedico` (1x)
- `FormularioPaciente` (1x)
- `FormularioFornecedor` (1x)
- `FormularioRepresentante` (1x)
- `FormularioTransportadora` (1x)

**Componentes Customizados:**
- `CNPJInput` - Input com valida√ß√£o CNPJ
- `CPFInput` - Input com valida√ß√£o CPF
- `CRMInput` - Input CRM + UF
- `CEPAutocomplete` - Autocomplete de endere√ßo
- `DocumentUploader` - Upload de documentos

**√çcones:**
- `Building` - Hospitais
- `Stethoscope` - M√©dicos
- `User` - Pacientes
- `Package` - Fornecedores
- `UserCheck` - Representantes
- `Truck` - Transportadoras

### üîß Funcionalidades Frontend

#### A. Tabela de Hospitais com Filtros

```tsx
<div className="space-y-4">
  {/* Barra de Busca e A√ß√µes */}
  <div className="flex justify-between items-center">
    <SearchBar
      placeholder="Buscar hospital..."
      onSearch={handleSearch}
    />
    <div className="flex gap-2">
      <Button variant="outline" onClick={() => setShowFilters(!showFilters)}>
        <Filter size={16} className="mr-2" />
        Filtros
      </Button>
      <Button onClick={() => setShowFormModal(true)}>
        <Plus size={16} className="mr-2" />
        Novo Hospital
      </Button>
    </div>
  </div>
  
  {/* Painel de Filtros */}
  {showFilters && (
    <Card>
      <CardContent className="pt-6">
        <div className="grid grid-cols-4 gap-4">
          <Select value={tipoFilter} onValueChange={setTipoFilter}>
            <SelectTrigger>Tipo</SelectTrigger>
            <SelectContent>
              <SelectItem value="todos">Todos</SelectItem>
              <SelectItem value="publico">P√∫blico</SelectItem>
              <SelectItem value="privado">Privado</SelectItem>
            </SelectContent>
          </Select>
          
          <Select value={statusFilter} onValueChange={setStatusFilter}>
            <SelectTrigger>Status</SelectTrigger>
            <SelectContent>
              <SelectItem value="todos">Todos</SelectItem>
              <SelectItem value="ativo">Ativo</SelectItem>
              <SelectItem value="inativo">Inativo</SelectItem>
            </SelectContent>
          </Select>
          
          <Select value={estadoFilter} onValueChange={setEstadoFilter}>
            <SelectTrigger>Estado</SelectTrigger>
            <SelectContent>
              {estados.map(uf => (
                <SelectItem key={uf} value={uf}>{uf}</SelectItem>
              ))}
            </SelectContent>
          </Select>
          
          <Button variant="ghost" onClick={limparFiltros}>
            Limpar Filtros
          </Button>
        </div>
      </CardContent>
    </Card>
  )}
  
  {/* Tabela */}
  <DataTable
    columns={[
      { accessorKey: 'razao_social', header: 'Raz√£o Social' },
      { accessorKey: 'cnpj', header: 'CNPJ', cell: formatCNPJ },
      { accessorKey: 'cidade', header: 'Cidade' },
      { accessorKey: 'uf', header: 'UF' },
      { accessorKey: 'tipo', header: 'Tipo', cell: renderBadgeTipo },
      { accessorKey: 'status', header: 'Status', cell: renderBadgeStatus },
      { id: 'acoes', header: 'A√ß√µes', cell: renderAcoes }
    ]}
    data={hospitais}
    pagination={{
      pageIndex: page,
      pageSize: pageSize,
      totalPages: totalPages
    }}
    onPaginationChange={handlePaginationChange}
  />
</div>
```

#### B. Formul√°rio de Hospital com Valida√ß√µes

```tsx
<Dialog open={showFormModal} onOpenChange={setShowFormModal}>
  <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
    <DialogHeader>
      <DialogTitle>Cadastro de Hospital</DialogTitle>
    </DialogHeader>
    
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Se√ß√£o: Dados Principais */}
      <div className="space-y-4">
        <h3 className="font-semibold">Dados Principais</h3>
        
        <div className="grid grid-cols-2 gap-4">
          <div>
            <Label htmlFor="cnpj">CNPJ *</Label>
            <CNPJInput
              id="cnpj"
              value={formData.cnpj}
              onChange={(value, isValid) => {
                setFormData({ ...formData, cnpj: value });
                if (isValid) buscarDadosReceitaFederal(value);
              }}
              onValidate={(isValid) => setErrors({ ...errors, cnpj: !isValid })}
            />
            {errors.cnpj && (
              <span className="text-sm text-red-500">CNPJ inv√°lido</span>
            )}
          </div>
          
          <div>
            <Label htmlFor="cnes">CNES *</Label>
            <Input
              id="cnes"
              value={formData.cnes}
              onChange={(e) => setFormData({ ...formData, cnes: e.target.value })}
              placeholder="0000000"
              maxLength={7}
            />
          </div>
        </div>
        
        <div>
          <Label htmlFor="razao_social">Raz√£o Social *</Label>
          <Input
            id="razao_social"
            value={formData.razao_social}
            onChange={(e) => setFormData({ ...formData, razao_social: e.target.value })}
            disabled={loadingReceitaFederal}
          />
        </div>
        
        <div>
          <Label htmlFor="nome_fantasia">Nome Fantasia</Label>
          <Input
            id="nome_fantasia"
            value={formData.nome_fantasia}
            onChange={(e) => setFormData({ ...formData, nome_fantasia: e.target.value })}
          />
        </div>
      </div>
      
      {/* Se√ß√£o: Endere√ßo */}
      <div className="space-y-4">
        <h3 className="font-semibold">Endere√ßo</h3>
        
        <div className="grid grid-cols-4 gap-4">
          <div className="col-span-1">
            <Label htmlFor="cep">CEP *</Label>
            <CEPAutocomplete
              value={formData.cep}
              onChange={(cep, endereco) => {
                setFormData({
                  ...formData,
                  cep,
                  logradouro: endereco.logradouro,
                  bairro: endereco.bairro,
                  cidade: endereco.cidade,
                  uf: endereco.uf
                });
              }}
            />
          </div>
          
          <div className="col-span-3">
            <Label htmlFor="logradouro">Logradouro *</Label>
            <Input
              id="logradouro"
              value={formData.logradouro}
              onChange={(e) => setFormData({ ...formData, logradouro: e.target.value })}
            />
          </div>
        </div>
        
        <div className="grid grid-cols-4 gap-4">
          <div className="col-span-1">
            <Label htmlFor="numero">N√∫mero *</Label>
            <Input
              id="numero"
              value={formData.numero}
              onChange={(e) => setFormData({ ...formData, numero: e.target.value })}
            />
          </div>
          
          <div className="col-span-1">
            <Label htmlFor="complemento">Complemento</Label>
            <Input
              id="complemento"
              value={formData.complemento}
              onChange={(e) => setFormData({ ...formData, complemento: e.target.value })}
            />
          </div>
          
          <div className="col-span-2">
            <Label htmlFor="bairro">Bairro *</Label>
            <Input
              id="bairro"
              value={formData.bairro}
              onChange={(e) => setFormData({ ...formData, bairro: e.target.value })}
            />
          </div>
        </div>
        
        <div className="grid grid-cols-2 gap-4">
          <div>
            <Label htmlFor="cidade">Cidade *</Label>
            <Input
              id="cidade"
              value={formData.cidade}
              onChange={(e) => setFormData({ ...formData, cidade: e.target.value })}
            />
          </div>
          
          <div>
            <Label htmlFor="uf">UF *</Label>
            <Select value={formData.uf} onValueChange={(v) => setFormData({ ...formData, uf: v })}>
              <SelectTrigger>UF</SelectTrigger>
              <SelectContent>
                {estados.map(uf => (
                  <SelectItem key={uf} value={uf}>{uf}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>
      </div>
      
      {/* Se√ß√£o: Contato */}
      <div className="space-y-4">
        <h3 className="font-semibold">Contato</h3>
        
        <div className="grid grid-cols-3 gap-4">
          <div>
            <Label htmlFor="telefone">Telefone *</Label>
            <Input
              id="telefone"
              type="tel"
              value={formData.telefone}
              onChange={(e) => setFormData({ ...formData, telefone: e.target.value })}
              placeholder="(00) 0000-0000"
            />
          </div>
          
          <div>
            <Label htmlFor="email">Email *</Label>
            <Input
              id="email"
              type="email"
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
            />
          </div>
          
          <div>
            <Label htmlFor="website">Website</Label>
            <Input
              id="website"
              type="url"
              value={formData.website}
              onChange={(e) => setFormData({ ...formData, website: e.target.value })}
              placeholder="https://"
            />
          </div>
        </div>
      </div>
      
      {/* Se√ß√£o: Classifica√ß√£o */}
      <div className="space-y-4">
        <h3 className="font-semibold">Classifica√ß√£o</h3>
        
        <div className="grid grid-cols-2 gap-4">
          <div>
            <Label htmlFor="tipo">Tipo *</Label>
            <Select value={formData.tipo} onValueChange={(v) => setFormData({ ...formData, tipo: v })}>
              <SelectTrigger>Tipo</SelectTrigger>
              <SelectContent>
                <SelectItem value="publico">P√∫blico</SelectItem>
                <SelectItem value="privado">Privado</SelectItem>
              </SelectContent>
            </Select>
          </div>
          
          <div>
            <Label htmlFor="porte">Porte</Label>
            <Select value={formData.porte} onValueChange={(v) => setFormData({ ...formData, porte: v })}>
              <SelectTrigger>Porte</SelectTrigger>
              <SelectContent>
                <SelectItem value="pequeno">Pequeno (&lt; 50 leitos)</SelectItem>
                <SelectItem value="medio">M√©dio (50-150 leitos)</SelectItem>
                <SelectItem value="grande">Grande (&gt; 150 leitos)</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>
        
        <div>
          <Label htmlFor="especialidades">Especialidades Atendidas</Label>
          <MultiSelect
            options={especialidades}
            value={formData.especialidades}
            onChange={(v) => setFormData({ ...formData, especialidades: v })}
            placeholder="Selecione as especialidades"
          />
        </div>
      </div>
      
      {/* Se√ß√£o: Documentos */}
      <div className="space-y-4">
        <h3 className="font-semibold">Documentos</h3>
        
        <DocumentUploader
          label="Alvar√° Sanit√°rio"
          accept=".pdf,.jpg,.png"
          onUpload={(file) => handleDocumentUpload('alvara', file)}
          currentFile={formData.documentos.alvara}
        />
        
        <DocumentUploader
          label="Comprovante de Inscri√ß√£o CNES"
          accept=".pdf,.jpg,.png"
          onUpload={(file) => handleDocumentUpload('cnes', file)}
          currentFile={formData.documentos.cnes}
        />
      </div>
      
      {/* A√ß√µes */}
      <DialogFooter>
        <Button type="button" variant="outline" onClick={() => setShowFormModal(false)}>
          Cancelar
        </Button>
        <Button type="submit" disabled={isSubmitting}>
          {isSubmitting ? 'Salvando...' : 'Salvar Hospital'}
        </Button>
      </DialogFooter>
    </form>
  </DialogContent>
</Dialog>
```

### ‚öôÔ∏è Funcionalidades Backend

#### A. APIs REST

**1. GET `/api/cadastros/hospitais`**
```typescript
Query Params: {
  page: number,
  pageSize: number,
  search?: string,
  tipo?: 'publico' | 'privado',
  status?: 'ativo' | 'inativo',
  uf?: string
}

Response: {
  hospitais: [
    {
      id: "hosp-001",
      cnpj: "12345678000190",
      razao_social: "Hospital Santa Casa",
      nome_fantasia: "Santa Casa",
      cnes: "1234567",
      endereco: {
        cep: "01234-567",
        logradouro: "Rua Exemplo",
        numero: "123",
        bairro: "Centro",
        cidade: "S√£o Paulo",
        uf: "SP"
      },
      contato: {
        telefone: "(11) 1234-5678",
        email: "contato@santacasa.com.br",
        website: "https://santacasa.com.br"
      },
      tipo: "privado",
      porte: "grande",
      especialidades: ["Cardiologia", "Ortopedia"],
      status: "ativo",
      criado_em: "2024-01-15",
      atualizado_em: "2025-11-23"
    }
  ],
  total: 150,
  page: 1,
  totalPages: 15
}
```

**2. POST `/api/cadastros/hospitais`**
```typescript
Body: {
  cnpj: string,
  razao_social: string,
  nome_fantasia?: string,
  cnes: string,
  endereco: {
    cep: string,
    logradouro: string,
    numero: string,
    complemento?: string,
    bairro: string,
    cidade: string,
    uf: string
  },
  contato: {
    telefone: string,
    email: string,
    website?: string
  },
  tipo: 'publico' | 'privado',
  porte?: 'pequeno' | 'medio' | 'grande',
  especialidades: string[],
  responsavel_tecnico?: {
    nome: string,
    crm: string,
    uf: string
  }
}

Response: {
  id: "hosp-new-001",
  status: "criado",
  mensagem: "Hospital cadastrado com sucesso"
}
```

**3. PUT `/api/cadastros/hospitais/:id`**
```typescript
Body: { /* mesma estrutura do POST */ }
Response: { status: "atualizado" }
```

**4. DELETE `/api/cadastros/hospitais/:id`**
```typescript
Response: { status: "excluido" }
```

**5. GET `/api/cadastros/hospitais/:id/historico`**
```typescript
Response: {
  historico: [
    {
      data: "2025-11-20T10:30:00Z",
      usuario: "Jo√£o Silva",
      acao: "atualiza√ß√£o",
      campos_alterados: ["telefone", "email"],
      valores_anteriores: {...},
      valores_novos: {...}
    }
  ]
}
```

#### B. Valida√ß√µes Externas

**1. Valida√ß√£o de CNPJ (Receita Federal)**
```typescript
async function validarCNPJ(cnpj: string) {
  const response = await fetch(`https://www.receitaws.com.br/v1/cnpj/${cnpj}`);
  const data = await response.json();
  
  if (data.status === 'OK') {
    return {
      valido: true,
      razao_social: data.nome,
      nome_fantasia: data.fantasia,
      endereco: {
        logradouro: data.logradouro,
        numero: data.numero,
        bairro: data.bairro,
        cidade: data.municipio,
        uf: data.uf,
        cep: data.cep
      }
    };
  }
  
  return { valido: false };
}
```

**2. Valida√ß√£o de CRM (CFM)**
```typescript
async function validarCRM(crm: string, uf: string) {
  // API do CFM (Conselho Federal de Medicina)
  const response = await fetch(`https://portal.cfm.org.br/api/medico/validar`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ crm, uf })
  });
  
  const data = await response.json();
  return {
    valido: data.situacao === 'REGULAR',
    nome: data.nome,
    especialidades: data.especialidades
  };
}
```

**3. Autocomplete de CEP (ViaCEP)**
```typescript
async function buscarEnderecoPorCEP(cep: string) {
  const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
  const data = await response.json();
  
  if (!data.erro) {
    return {
      logradouro: data.logradouro,
      bairro: data.bairro,
      cidade: data.localidade,
      uf: data.uf
    };
  }
  
  return null;
}
```

#### C. Banco de Dados (Supabase)

**Tabelas:**

**1. hospitais**
```sql
CREATE TABLE hospitais (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  cnpj VARCHAR(14) UNIQUE NOT NULL,
  razao_social VARCHAR(200) NOT NULL,
  nome_fantasia VARCHAR(200),
  cnes VARCHAR(7) UNIQUE NOT NULL,
  inscricao_estadual VARCHAR(20),
  cep VARCHAR(8) NOT NULL,
  logradouro VARCHAR(200) NOT NULL,
  numero VARCHAR(20) NOT NULL,
  complemento VARCHAR(100),
  bairro VARCHAR(100) NOT NULL,
  cidade VARCHAR(100) NOT NULL,
  uf CHAR(2) NOT NULL,
  telefone VARCHAR(20) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  website VARCHAR(200),
  tipo VARCHAR(10) CHECK (tipo IN ('publico', 'privado')),
  porte VARCHAR(10) CHECK (porte IN ('pequeno', 'medio', 'grande')),
  especialidades JSONB,
  responsavel_tecnico JSONB,
  documentos JSONB,
  status VARCHAR(10) DEFAULT 'ativo',
  criado_em TIMESTAMP DEFAULT NOW(),
  criado_por UUID REFERENCES usuarios(id),
  atualizado_em TIMESTAMP,
  atualizado_por UUID REFERENCES usuarios(id)
);

CREATE INDEX idx_hospitais_cnpj ON hospitais(cnpj);
CREATE INDEX idx_hospitais_cnes ON hospitais(cnes);
CREATE INDEX idx_hospitais_cidade_uf ON hospitais(cidade, uf);
CREATE INDEX idx_hospitais_status ON hospitais(status);
```

**2. medicos**
```sql
CREATE TABLE medicos (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  cpf VARCHAR(11) UNIQUE NOT NULL,
  nome_completo VARCHAR(200) NOT NULL,
  crm VARCHAR(10) NOT NULL,
  crm_uf CHAR(2) NOT NULL,
  rqe VARCHAR(20),
  especialidades JSONB NOT NULL,
  telefone VARCHAR(20) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  data_nascimento DATE,
  hospitais_atendidos UUID[] REFERENCES hospitais(id),
  status VARCHAR(10) DEFAULT 'ativo',
  criado_em TIMESTAMP DEFAULT NOW(),
  atualizado_em TIMESTAMP,
  UNIQUE(crm, crm_uf)
);

CREATE INDEX idx_medicos_cpf ON medicos(cpf);
CREATE INDEX idx_medicos_crm ON medicos(crm, crm_uf);
CREATE INDEX idx_medicos_nome ON medicos(nome_completo);
```

**3. pacientes**
```sql
CREATE TABLE pacientes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  cpf VARCHAR(11) UNIQUE,
  cartao_sus VARCHAR(15) UNIQUE,
  nome_completo VARCHAR(200) NOT NULL,
  data_nascimento DATE NOT NULL,
  sexo CHAR(1) CHECK (sexo IN ('M', 'F', 'O')),
  telefone VARCHAR(20),
  email VARCHAR(100),
  cep VARCHAR(8),
  logradouro VARCHAR(200),
  numero VARCHAR(20),
  complemento VARCHAR(100),
  bairro VARCHAR(100),
  cidade VARCHAR(100),
  uf CHAR(2),
  convenio_id UUID REFERENCES convenios(id),
  numero_carteirinha VARCHAR(50),
  observacoes_medicas TEXT,
  status VARCHAR(10) DEFAULT 'ativo',
  criado_em TIMESTAMP DEFAULT NOW(),
  atualizado_em TIMESTAMP
);

CREATE INDEX idx_pacientes_cpf ON pacientes(cpf);
CREATE INDEX idx_pacientes_sus ON pacientes(cartao_sus);
CREATE INDEX idx_pacientes_nome ON pacientes(nome_completo);
```

**4. fornecedores**
```sql
CREATE TABLE fornecedores (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  cnpj VARCHAR(14) UNIQUE NOT NULL,
  razao_social VARCHAR(200) NOT NULL,
  nome_fantasia VARCHAR(200),
  inscricao_estadual VARCHAR(20),
  cep VARCHAR(8) NOT NULL,
  logradouro VARCHAR(200) NOT NULL,
  numero VARCHAR(20) NOT NULL,
  complemento VARCHAR(100),
  bairro VARCHAR(100) NOT NULL,
  cidade VARCHAR(100) NOT NULL,
  uf CHAR(2) NOT NULL,
  telefone VARCHAR(20) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  responsavel_comercial VARCHAR(200),
  condicoes_pagamento JSONB,
  produtos_fornecidos UUID[] REFERENCES produtos_opme(id),
  certificacoes JSONB,
  documentos JSONB,
  status VARCHAR(10) DEFAULT 'ativo',
  criado_em TIMESTAMP DEFAULT NOW(),
  atualizado_em TIMESTAMP
);
```

**5. cadastros_historico**
```sql
CREATE TABLE cadastros_historico (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tabela VARCHAR(50) NOT NULL,
  registro_id UUID NOT NULL,
  acao VARCHAR(20) NOT NULL CHECK (acao IN ('criacao', 'atualizacao', 'exclusao')),
  usuario_id UUID REFERENCES usuarios(id),
  campos_alterados JSONB,
  valores_anteriores JSONB,
  valores_novos JSONB,
  timestamp TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_historico_tabela_registro ON cadastros_historico(tabela, registro_id);
CREATE INDEX idx_historico_timestamp ON cadastros_historico(timestamp DESC);
```

#### D. Importa√ß√£o em Lote

**Endpoint:** POST `/api/cadastros/importar`

```typescript
async function importarCadastros(arquivo: File, tipo: string) {
  // 1. Parse do arquivo (CSV/Excel)
  const dados = await parseArquivo(arquivo);
  
  // 2. Valida√ß√£o em massa
  const validacoes = await Promise.all(
    dados.map(async (registro) => {
      const erros = [];
      
      // Validar CNPJ/CPF
      if (tipo === 'hospitais' || tipo === 'fornecedores') {
        const cnpjValido = await validarCNPJ(registro.cnpj);
        if (!cnpjValido.valido) erros.push('CNPJ inv√°lido');
      }
      
      // Validar CRM (m√©dicos)
      if (tipo === 'medicos') {
        const crmValido = await validarCRM(registro.crm, registro.crm_uf);
        if (!crmValido.valido) erros.push('CRM inv√°lido');
      }
      
      return {
        registro,
        valido: erros.length === 0,
        erros
      };
    })
  );
  
  // 3. Separar v√°lidos e inv√°lidos
  const validos = validacoes.filter(v => v.valido);
  const invalidos = validacoes.filter(v => !v.valido);
  
  // 4. Inserir registros v√°lidos
  const inseridos = await db[tipo].createMany({
    data: validos.map(v => v.registro)
  });
  
  // 5. Retornar relat√≥rio
  return {
    total: dados.length,
    importados: inseridos.count,
    erros: invalidos.map(inv => ({
      linha: inv.registro._linha,
      erros: inv.erros
    }))
  };
}
```

### üîå Integra√ß√µes

**Internas:**
- CRM Vendas ‚Üí Hospitais e M√©dicos
- Cirurgias ‚Üí M√©dicos e Pacientes
- Compras ‚Üí Fornecedores
- Log√≠stica ‚Üí Transportadoras
- Faturamento ‚Üí Hospitais e Pacientes

**Externas:**
- Receita Federal (CNPJ)
- CFM - Conselho Federal de Medicina (CRM)
- ViaCEP (Endere√ßos)
- DATASUS (Cart√£o SUS)

### üìä M√©tricas de Performance

**Carregamento:**
- Lista (100 registros): < 1s
- Busca: < 500ms
- Valida√ß√£o CNPJ: 1-3s (API externa)
- Importa√ß√£o (1000 registros): 10-30s

---

## 08. GRUPOS DE PRODUTOS OPME

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `GruposProdutosOPME.tsx` |
| **√çcone** | `Package` (Lucide React) |
| **Rota** | `/produtos-opme/grupos` |
| **Permiss√£o** | `produtos.view, produtos.manage` |
| **Categoria** | Cadastros & Gest√£o |
| **Status** | ‚úÖ Implementado 100% |

### üéØ Descri√ß√£o

Gerenciamento de grupos, categorias e subcategorias de produtos OPME (√ìrteses, Pr√≥teses e Materiais Especiais). Organiza√ß√£o hier√°rquica conforme ANVISA e SUS, com relacionamento de produtos e configura√ß√µes espec√≠ficas por grupo.

### üìã Sub-M√≥dulos (3)

1. **Grupos Principais** - Grandes categorias (Ortopedia, Cardiologia, etc)
2. **Categorias** - Subdivis√µes de grupos
3. **Subcategorias** - Detalhamento espec√≠fico

### üìù Formul√°rios (3)

#### 1. Criar Grupo
- **Campos:** Nome, Descri√ß√£o, C√≥digo ANVISA, √çcone, Cor Identifica√ß√£o, Requer Certifica√ß√£o Especial
- **Submit:** POST `/api/produtos-opme/grupos`

#### 2. Criar Categoria
- **Campos:** Nome, Grupo Pai, C√≥digo, Margem Padr√£o, Prazo Validade Padr√£o
- **Submit:** POST `/api/produtos-opme/categorias`

#### 3. Criar Subcategoria
- **Campos:** Nome, Categoria Pai, Caracter√≠sticas Espec√≠ficas
- **Submit:** POST `/api/produtos-opme/subcategorias`

### üé® Componentes Utilizados

- `TreeView` - Hierarquia de grupos
- `DraggableList` - Reordenar categorias
- `GroupCard` - Card de grupo com m√©tricas

### üîß Funcionalidades Frontend

```tsx
<div className="grid grid-cols-3 gap-6">
  {/* √Årvore de Navega√ß√£o */}
  <Card className="col-span-1">
    <CardHeader>
      <CardTitle>Hierarquia</CardTitle>
    </CardHeader>
    <CardContent>
      <TreeView
        data={hierarquia}
        onSelect={(node) => setSelectedNode(node)}
        renderNode={(node) => (
          <div className="flex items-center gap-2">
            {node.icone}
            <span>{node.nome}</span>
            <Badge>{node.total_produtos}</Badge>
          </div>
        )}
      />
    </CardContent>
  </Card>
  
  {/* Detalhes do Grupo/Categoria */}
  <Card className="col-span-2">
    <CardHeader>
      <CardTitle>{selectedNode?.nome}</CardTitle>
    </CardHeader>
    <CardContent>
      {/* Estat√≠sticas */}
      <div className="grid grid-cols-3 gap-4 mb-6">
        <div>
          <span className="text-sm text-muted-foreground">Total Produtos</span>
          <p className="text-2xl font-semibold">{selectedNode?.total_produtos}</p>
        </div>
        <div>
          <span className="text-sm text-muted-foreground">Valor em Estoque</span>
          <p className="text-2xl font-semibold">
            {formatCurrency(selectedNode?.valor_estoque)}
          </p>
        </div>
        <div>
          <span className="text-sm text-muted-foreground">Margem M√©dia</span>
          <p className="text-2xl font-semibold">{selectedNode?.margem_media}%</p>
        </div>
      </div>
      
      {/* Produtos do Grupo */}
      <DataTable
        columns={colunasProdutos}
        data={selectedNode?.produtos || []}
      />
    </CardContent>
  </Card>
</div>
```

### ‚öôÔ∏è Funcionalidades Backend

**APIs:**

**GET `/api/produtos-opme/grupos/hierarquia`**
```typescript
Response: {
  grupos: [
    {
      id: "grupo-001",
      nome: "Ortopedia",
      codigo_anvisa: "ORT",
      total_produtos: 1247,
      valor_estoque: 5420000,
      categorias: [
        {
          id: "cat-001",
          nome: "Pr√≥teses de Quadril",
          total_produtos: 156,
          subcategorias: [...]
        }
      ]
    }
  ]
}
```

### üîå Integra√ß√µes

**Internas:** Estoque IA, Compras, Vendas, Cirurgias  
**Externas:** ANVISA (valida√ß√£o de c√≥digos)

---

## 09. GEST√ÉO DE USU√ÅRIOS E PERMISS√ïES

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `GestaoUsuariosPermissoes.tsx` |
| **√çcone** | `Shield` (Lucide React) |
| **Rota** | `/configuracoes/usuarios` |
| **Permiss√£o** | `admin.users.manage` |
| **Categoria** | Cadastros & Gest√£o |
| **Status** | ‚úÖ Implementado 100% |

### üéØ Descri√ß√£o

Gerenciamento completo de usu√°rios, perfis, permiss√µes (RBAC), auditoria de acessos e autentica√ß√£o multifator (MFA).

### üìã Sub-M√≥dulos (5)

1. **Usu√°rios** - CRUD de usu√°rios
2. **Perfis/Roles** - Perfis de acesso
3. **Permiss√µes** - Granularidade de permiss√µes
4. **Auditoria** - Log de acessos e a√ß√µes
5. **Sess√µes Ativas** - Gerenciar sess√µes

### üìù Formul√°rios (4)

#### 1. Criar Usu√°rio
- **Campos:** Nome, Email, Telefone, CPF, Perfil, Departamento, Status, Foto
- **Valida√ß√£o:** Email √∫nico, CPF v√°lido
- **Submit:** POST `/api/usuarios`

#### 2. Criar Perfil
- **Campos:** Nome, Descri√ß√£o, Permiss√µes (multi-select), N√≠vel Acesso
- **Submit:** POST `/api/usuarios/perfis`

#### 3. Configurar MFA
- **Campos:** M√©todo (SMS/App/Email), Telefone/Email
- **Submit:** POST `/api/usuarios/:id/mfa/ativar`

#### 4. Redefinir Senha
- **Campos:** Senha Atual, Nova Senha, Confirmar Senha
- **Valida√ß√£o:** Senha forte (min 8 chars, mai√∫scula, min√∫scula, n√∫mero, especial)
- **Submit:** PUT `/api/usuarios/:id/senha`

### üé® Componentes Utilizados

- `UserTable` - Tabela de usu√°rios
- `RolePermissionMatrix` - Matriz de permiss√µes
- `AuditLog` - Log de auditoria
- `SessionManager` - Gerenciador de sess√µes
- `MFASetup` - Configura√ß√£o MFA

### üîß Funcionalidades Frontend

#### A. Tabela de Usu√°rios com A√ß√µes

```tsx
<DataTable
  columns={[
    {
      accessorKey: 'nome',
      header: 'Nome',
      cell: ({ row }) => (
        <div className="flex items-center gap-2">
          <Avatar>
            <AvatarImage src={row.original.foto} />
            <AvatarFallback>{row.original.iniciais}</AvatarFallback>
          </Avatar>
          <div>
            <p className="font-medium">{row.original.nome}</p>
            <p className="text-sm text-muted-foreground">{row.original.email}</p>
          </div>
        </div>
      )
    },
    { accessorKey: 'perfil', header: 'Perfil', cell: renderBadgePerfil },
    { accessorKey: 'departamento', header: 'Departamento' },
    { 
      accessorKey: 'status', 
      header: 'Status',
      cell: ({ row }) => (
        <Badge variant={row.original.status === 'ativo' ? 'default' : 'secondary'}>
          {row.original.status}
        </Badge>
      )
    },
    {
      accessorKey: 'mfa_ativo',
      header: 'MFA',
      cell: ({ row }) => (
        row.original.mfa_ativo ? (
          <CheckCircle className="text-green-500" size={18} />
        ) : (
          <XCircle className="text-gray-400" size={18} />
        )
      )
    },
    {
      id: 'acoes',
      header: 'A√ß√µes',
      cell: ({ row }) => (
        <DropdownMenu>
          <DropdownMenuTrigger>
            <Button variant="ghost" size="sm">
              <MoreVertical size={16} />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => editarUsuario(row.original.id)}>
              <Edit size={14} className="mr-2" />
              Editar
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => resetarSenha(row.original.id)}>
              <Key size={14} className="mr-2" />
              Resetar Senha
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => verAuditoria(row.original.id)}>
              <FileText size={14} className="mr-2" />
              Ver Auditoria
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            <DropdownMenuItem 
              onClick={() => desativarUsuario(row.original.id)}
              className="text-red-600"
            >
              <Ban size={14} className="mr-2" />
              Desativar
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      )
    }
  ]}
  data={usuarios}
/>
```

#### B. Matriz de Permiss√µes (RBAC)

```tsx
<Table>
  <TableHeader>
    <TableRow>
      <TableHead>Recurso</TableHead>
      {perfis.map(perfil => (
        <TableHead key={perfil.id}>{perfil.nome}</TableHead>
      ))}
    </TableRow>
  </TableHeader>
  <TableBody>
    {recursos.map(recurso => (
      <TableRow key={recurso.id}>
        <TableCell className="font-medium">{recurso.nome}</TableCell>
        {perfis.map(perfil => (
          <TableCell key={perfil.id}>
            <div className="flex gap-2">
              <Checkbox
                checked={temPermissao(perfil.id, recurso.id, 'view')}
                onCheckedChange={(checked) => 
                  atualizarPermissao(perfil.id, recurso.id, 'view', checked)
                }
              />
              <span className="text-xs">View</span>
              
              <Checkbox
                checked={temPermissao(perfil.id, recurso.id, 'edit')}
                onCheckedChange={(checked) => 
                  atualizarPermissao(perfil.id, recurso.id, 'edit', checked)
                }
              />
              <span className="text-xs">Edit</span>
              
              <Checkbox
                checked={temPermissao(perfil.id, recurso.id, 'delete')}
                onCheckedChange={(checked) => 
                  atualizarPermissao(perfil.id, recurso.id, 'delete', checked)
                }
              />
              <span className="text-xs">Delete</span>
            </div>
          </TableCell>
        ))}
      </TableRow>
    ))}
  </TableBody>
</Table>
```

#### C. Log de Auditoria

```tsx
<Card>
  <CardHeader>
    <CardTitle>Log de Auditoria</CardTitle>
    <CardDescription>√öltimas 100 a√ß√µes do sistema</CardDescription>
  </CardHeader>
  <CardContent>
    <div className="space-y-3">
      {auditLogs.map(log => (
        <div key={log.id} className="flex items-start gap-3 p-3 border rounded-md">
          <div className="flex-shrink-0 mt-1">
            {log.tipo === 'criacao' && <Plus className="text-green-500" size={18} />}
            {log.tipo === 'atualizacao' && <Edit className="text-blue-500" size={18} />}
            {log.tipo === 'exclusao' && <Trash className="text-red-500" size={18} />}
            {log.tipo === 'acesso' && <Eye className="text-gray-500" size={18} />}
          </div>
          
          <div className="flex-1">
            <div className="flex items-center gap-2 mb-1">
              <span className="font-medium">{log.usuario_nome}</span>
              <Badge variant="outline">{log.tipo}</Badge>
              <span className="text-sm text-muted-foreground">
                {formatDistanceToNow(new Date(log.timestamp), { addSuffix: true, locale: ptBR })}
              </span>
            </div>
            
            <p className="text-sm">{log.descricao}</p>
            
            {log.detalhes && (
              <details className="mt-2">
                <summary className="text-sm cursor-pointer text-blue-600">
                  Ver detalhes
                </summary>
                <pre className="text-xs mt-2 p-2 bg-gray-100 rounded overflow-x-auto">
                  {JSON.stringify(log.detalhes, null, 2)}
                </pre>
              </details>
            )}
          </div>
        </div>
      ))}
    </div>
  </CardContent>
</Card>
```

#### D. Configura√ß√£o de MFA

```tsx
<Dialog open={showMFADialog} onOpenChange={setShowMFADialog}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Configurar Autentica√ß√£o Multifator (MFA)</DialogTitle>
      <DialogDescription>
        Adicione uma camada extra de seguran√ßa √† sua conta
      </DialogDescription>
    </DialogHeader>
    
    <Tabs defaultValue="app">
      <TabsList className="grid w-full grid-cols-3">
        <TabsTrigger value="app">App Autenticador</TabsTrigger>
        <TabsTrigger value="sms">SMS</TabsTrigger>
        <TabsTrigger value="email">Email</TabsTrigger>
      </TabsList>
      
      <TabsContent value="app" className="space-y-4">
        <div className="text-center">
          <p className="mb-4">Escaneie o QR Code com seu app autenticador:</p>
          <QRCodeSVG value={mfaSetup.qr_url} size={200} className="mx-auto" />
        </div>
        
        <div>
          <Label htmlFor="codigo">C√≥digo de Verifica√ß√£o</Label>
          <Input
            id="codigo"
            placeholder="000000"
            maxLength={6}
            value={codigoMFA}
            onChange={(e) => setCodigoMFA(e.target.value)}
          />
        </div>
        
        <Button 
          onClick={verificarMFA} 
          disabled={codigoMFA.length !== 6}
          className="w-full"
        >
          Verificar e Ativar MFA
        </Button>
      </TabsContent>
      
      <TabsContent value="sms" className="space-y-4">
        <div>
          <Label htmlFor="telefone">Telefone</Label>
          <Input
            id="telefone"
            type="tel"
            placeholder="(00) 00000-0000"
            value={telefoneMFA}
            onChange={(e) => setTelefoneMFA(e.target.value)}
          />
        </div>
        
        <Button onClick={enviarSMS} className="w-full">
          Enviar C√≥digo por SMS
        </Button>
      </TabsContent>
      
      <TabsContent value="email" className="space-y-4">
        <p>Um c√≥digo ser√° enviado para: <strong>{usuario.email}</strong></p>
        <Button onClick={enviarEmail} className="w-full">
          Enviar C√≥digo por Email
        </Button>
      </TabsContent>
    </Tabs>
  </DialogContent>
</Dialog>
```

### ‚öôÔ∏è Funcionalidades Backend

#### A. APIs REST

**1. GET `/api/usuarios`**
```typescript
Response: {
  usuarios: [
    {
      id: "user-001",
      nome: "Jo√£o Silva",
      email: "joao@example.com",
      cpf: "12345678900",
      telefone: "(11) 98765-4321",
      perfil_id: "perfil-admin",
      perfil_nome: "Administrador",
      departamento: "TI",
      foto_url: "https://...",
      mfa_ativo: true,
      status: "ativo",
      ultimo_acesso: "2025-11-23T10:30:00Z",
      criado_em: "2024-01-15"
    }
  ]
}
```

**2. POST `/api/usuarios`**
```typescript
Body: {
  nome: string,
  email: string,
  cpf: string,
  telefone: string,
  perfil_id: string,
  departamento: string,
  senha_temporaria?: string
}

Response: {
  id: "user-new-001",
  senha_temporaria: "Abc123!@#",
  mensagem: "Usu√°rio criado. Senha tempor√°ria enviada por email."
}
```

**3. GET `/api/usuarios/perfis`**
```typescript
Response: {
  perfis: [
    {
      id: "perfil-admin",
      nome: "Administrador",
      descricao: "Acesso total ao sistema",
      nivel: 10,
      permissoes: [
        {
          recurso: "usuarios",
          acoes: ["view", "create", "edit", "delete"]
        },
        {
          recurso: "configuracoes",
          acoes: ["view", "edit"]
        }
      ],
      total_usuarios: 5
    }
  ]
}
```

**4. PUT `/api/usuarios/:id/permissoes`**
```typescript
Body: {
  perfil_id: string,
  permissoes_customizadas?: Array<{
    recurso: string,
    acoes: string[]
  }>
}

Response: { status: "atualizado" }
```

**5. GET `/api/usuarios/:id/auditoria`**
```typescript
Query: { page, pageSize, tipo?, data_inicio?, data_fim? }

Response: {
  logs: [
    {
      id: "log-001",
      usuario_id: "user-001",
      usuario_nome: "Jo√£o Silva",
      tipo: "atualizacao",
      recurso: "hospitais",
      recurso_id: "hosp-001",
      acao: "editar",
      descricao: "Atualizou dados do Hospital Santa Casa",
      ip: "192.168.1.100",
      user_agent: "Mozilla/5.0...",
      timestamp: "2025-11-23T10:30:00Z",
      detalhes: {
        campos_alterados: ["telefone", "email"],
        valores_anteriores: {...},
        valores_novos: {...}
      }
    }
  ],
  total: 450
}
```

**6. POST `/api/usuarios/:id/mfa/ativar`**
```typescript
Body: {
  metodo: 'app' | 'sms' | 'email',
  telefone?: string
}

Response: {
  qr_url?: string,  // Se m√©todo = app
  secret?: string,   // Se m√©todo = app
  codigo_enviado?: boolean,  // Se m√©todo = sms/email
  backup_codes: string[]  // C√≥digos de recupera√ß√£o
}
```

**7. POST `/api/usuarios/:id/mfa/verificar`**
```typescript
Body: {
  codigo: string
}

Response: {
  valido: boolean,
  mfa_ativo: boolean
}
```

**8. GET `/api/usuarios/sessoes-ativas`**
```typescript
Response: {
  sessoes: [
    {
      id: "session-001",
      usuario_id: "user-001",
      usuario_nome: "Jo√£o Silva",
      ip: "192.168.1.100",
      localizacao: "S√£o Paulo, SP - Brasil",
      dispositivo: "Chrome 120 on Windows",
      inicio: "2025-11-23T08:00:00Z",
      ultima_atividade: "2025-11-23T10:30:00Z",
      expira_em: "2025-11-23T20:00:00Z"
    }
  ]
}
```

**9. DELETE `/api/usuarios/sessoes/:id`**
```typescript
Response: {
  status: "encerrada",
  mensagem: "Sess√£o encerrada com sucesso"
}
```

#### B. Middleware de Autoriza√ß√£o (RBAC)

```typescript
// middleware/authorization.ts

export function authorize(recurso: string, acao: string) {
  return async (req: Request, res: Response, next: NextFunction) => {
    const usuario_id = req.user.id;
    
    // 1. Buscar perfil e permiss√µes do usu√°rio
    const usuario = await db.usuarios.findUnique({
      where: { id: usuario_id },
      include: {
        perfil: {
          include: { permissoes: true }
        },
        permissoes_customizadas: true
      }
    });
    
    // 2. Verificar se tem permiss√£o no perfil
    const permissao_perfil = usuario.perfil.permissoes.find(
      p => p.recurso === recurso && p.acoes.includes(acao)
    );
    
    // 3. Verificar permiss√µes customizadas
    const permissao_custom = usuario.permissoes_customizadas.find(
      p => p.recurso === recurso && p.acoes.includes(acao)
    );
    
    if (permissao_perfil || permissao_custom) {
      // 4. Registrar acesso no log de auditoria
      await db.auditoria.create({
        data: {
          usuario_id,
          tipo: 'acesso',
          recurso,
          acao,
          ip: req.ip,
          user_agent: req.headers['user-agent'],
          timestamp: new Date()
        }
      });
      
      return next();
    }
    
    // Sem permiss√£o
    return res.status(403).json({
      erro: 'Acesso negado',
      mensagem: `Voc√™ n√£o tem permiss√£o para ${acao} em ${recurso}`
    });
  };
}

// Uso em rotas
app.get('/api/hospitais', 
  authenticate,
  authorize('hospitais', 'view'),
  async (req, res) => {
    // L√≥gica da rota
  }
);
```

#### C. Banco de Dados

**1. usuarios**
```sql
CREATE TABLE usuarios (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  nome VARCHAR(200) NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  cpf VARCHAR(11) UNIQUE NOT NULL,
  telefone VARCHAR(20),
  senha_hash TEXT NOT NULL,
  perfil_id UUID REFERENCES perfis(id),
  departamento VARCHAR(100),
  foto_url TEXT,
  mfa_ativo BOOLEAN DEFAULT FALSE,
  mfa_metodo VARCHAR(10),
  mfa_secret TEXT,
  backup_codes TEXT[],
  status VARCHAR(10) DEFAULT 'ativo',
  ultimo_acesso TIMESTAMP,
  criado_em TIMESTAMP DEFAULT NOW(),
  atualizado_em TIMESTAMP
);
```

**2. perfis**
```sql
CREATE TABLE perfis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  nome VARCHAR(100) UNIQUE NOT NULL,
  descricao TEXT,
  nivel INTEGER NOT NULL,
  criado_em TIMESTAMP DEFAULT NOW()
);
```

**3. permissoes**
```sql
CREATE TABLE permissoes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  perfil_id UUID REFERENCES perfis(id),
  recurso VARCHAR(100) NOT NULL,
  acoes TEXT[] NOT NULL,
  UNIQUE(perfil_id, recurso)
);
```

**4. auditoria**
```sql
CREATE TABLE auditoria (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  usuario_id UUID REFERENCES usuarios(id),
  tipo VARCHAR(20) NOT NULL,
  recurso VARCHAR(100),
  recurso_id UUID,
  acao VARCHAR(50),
  descricao TEXT,
  ip VARCHAR(45),
  user_agent TEXT,
  detalhes JSONB,
  timestamp TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_auditoria_usuario ON auditoria(usuario_id, timestamp DESC);
CREATE INDEX idx_auditoria_recurso ON auditoria(recurso, recurso_id);
CREATE INDEX idx_auditoria_timestamp ON auditoria(timestamp DESC);
```

**5. sessoes**
```sql
CREATE TABLE sessoes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  usuario_id UUID REFERENCES usuarios(id),
  token_hash TEXT NOT NULL,
  ip VARCHAR(45),
  localizacao VARCHAR(200),
  dispositivo VARCHAR(200),
  inicio TIMESTAMP DEFAULT NOW(),
  ultima_atividade TIMESTAMP DEFAULT NOW(),
  expira_em TIMESTAMP NOT NULL
);

CREATE INDEX idx_sessoes_usuario ON sessoes(usuario_id);
CREATE INDEX idx_sessoes_token ON sessoes(token_hash);
```

### üîå Integra√ß√µes

**Internas:** Todos os m√≥dulos (autentica√ß√£o e autoriza√ß√£o)  
**Externas:** 
- Auth0 / Supabase Auth (autentica√ß√£o)
- Google Authenticator / Authy (MFA)
- SendGrid (envio de emails)
- Twilio (envio de SMS)

---

## 10. GEST√ÉO DE CONTRATOS

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `GestaoContratosNovo.tsx` |
| **√çcone** | `FileSignature` (Lucide React) |
| **Rota** | `/contratos` |
| **Permiss√£o** | `contratos.view, contratos.manage` |
| **Status** | ‚úÖ Implementado 100% |

### üéØ Descri√ß√£o

Gerenciamento completo de contratos com hospitais, fornecedores e representantes. Controle de vig√™ncia, renova√ß√µes autom√°ticas, alertas de vencimento, assinatura digital e reposit√≥rio de documentos.

### üìã Sub-M√≥dulos (4)

1. **Contratos Ativos** - Contratos vigentes
2. **Contratos a Vencer** - Pr√≥ximos de expirar (30, 60, 90 dias)
3. **Contratos Vencidos** - Expirados
4. **Hist√≥rico** - Contratos encerrados

### üìù Formul√°rios (2)

#### 1. Criar Contrato
- **Campos:** Tipo (Cliente/Fornecedor/Representante), Parte Contratada, N√∫mero, Objeto, Valor, Data In√≠cio, Data Fim, Renova√ß√£o Autom√°tica, Condi√ß√µes, Anexos
- **Submit:** POST `/api/contratos`

#### 2. Renovar Contrato
- **Campos:** Nova Data Fim, Novo Valor (opcional), Observa√ß√µes
- **Submit:** POST `/api/contratos/:id/renovar`

### üé® Componentes

- `ContratoCard` - Card de contrato com status
- `TimelineVisualization` - Linha do tempo de vig√™ncia
- `SignatureDialog` - Assinatura digital
- `DocumentViewer` - Visualizador de PDFs

### üîß Funcionalidades Frontend

```tsx
<Tabs defaultValue="ativos">
  <TabsList>
    <TabsTrigger value="ativos">
      Ativos ({contratos.ativos.length})
    </TabsTrigger>
    <TabsTrigger value="vencer">
      A Vencer ({contratos.aVencer.length})
      {contratos.aVencer.length > 0 && (
        <Badge variant="destructive" className="ml-2">{contratos.aVencer.length}</Badge>
      )}
    </TabsTrigger>
    <TabsTrigger value="vencidos">
      Vencidos ({contratos.vencidos.length})
    </TabsTrigger>
  </TabsList>
  
  <TabsContent value="ativos">
    <div className="grid gap-4">
      {contratos.ativos.map(contrato => (
        <Card key={contrato.id}>
          <CardHeader>
            <div className="flex justify-between items-start">
              <div>
                <CardTitle>{contrato.numero} - {contrato.parte_contratada}</CardTitle>
                <CardDescription>{contrato.objeto}</CardDescription>
              </div>
              <Badge variant="default">Ativo</Badge>
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-4 gap-4">
              <div>
                <span className="text-sm text-muted-foreground">Valor</span>
                <p className="font-semibold">{formatCurrency(contrato.valor)}</p>
              </div>
              <div>
                <span className="text-sm text-muted-foreground">In√≠cio</span>
                <p>{format(contrato.data_inicio, 'dd/MM/yyyy')}</p>
              </div>
              <div>
                <span className="text-sm text-muted-foreground">T√©rmino</span>
                <p>{format(contrato.data_fim, 'dd/MM/yyyy')}</p>
              </div>
              <div>
                <span className="text-sm text-muted-foreground">Dias Restantes</span>
                <p className="font-semibold">{contrato.dias_restantes}</p>
              </div>
            </div>
            
            {/* Timeline de Vig√™ncia */}
            <div className="mt-4">
              <Progress value={contrato.percentual_decorrido} className="h-2" />
              <div className="flex justify-between text-xs text-muted-foreground mt-1">
                <span>Decorrido: {contrato.percentual_decorrido}%</span>
                <span>{contrato.dias_restantes} dias restantes</span>
              </div>
            </div>
            
            <div className="flex gap-2 mt-4">
              <Button size="sm" variant="outline" onClick={() => verContrato(contrato.id)}>
                <Eye size={14} className="mr-2" />
                Visualizar
              </Button>
              <Button size="sm" variant="outline" onClick={() => renovarContrato(contrato.id)}>
                <RefreshCw size={14} className="mr-2" />
                Renovar
              </Button>
              <Button size="sm" variant="outline" onClick={() => aditivar(contrato.id)}>
                <FileText size={14} className="mr-2" />
                Aditivo
              </Button>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  </TabsContent>
</Tabs>
```

### ‚öôÔ∏è Backend

**APIs:**

**GET `/api/contratos`**
```typescript
Query: { status?, tipo?, parte_contratada_id? }
Response: {
  contratos: [{
    id, numero, tipo, parte_contratada, objeto,
    valor, data_inicio, data_fim, dias_restantes,
    percentual_decorrido, status, anexos
  }]
}
```

**POST `/api/contratos/:id/assinar`**
```typescript
Body: { assinante, assinatura_digital }
Response: { status: "assinado", certificado_url }
```

### üîå Integra√ß√µes

**Internas:** Hospitais, Fornecedores, Representantes, Financeiro  
**Externas:** DocuSign (assinatura digital), AWS S3 (armazenamento)

---

## 11. GEST√ÉO DE INVENT√ÅRIO

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `GestaoInventario.tsx` |
| **√çcone** | `ClipboardList` (Lucide React) |
| **Rota** | `/estoque/inventario` |
| **Permiss√£o** | `inventario.manage` |
| **Status** | ‚úÖ Implementado 100% |

### üéØ Descri√ß√£o

Realiza√ß√£o de invent√°rios f√≠sicos com contagem via coletor de dados, leitura de QR Code/RFID, diverg√™ncias autom√°ticas, ajustes de estoque e relat√≥rios de acuracidade.

### üìã Sub-M√≥dulos (5)

1. **Novo Invent√°rio** - Criar processo de contagem
2. **Em Andamento** - Invent√°rios sendo realizados
3. **Diverg√™ncias** - Itens com diferen√ßa f√≠sica√ósistema
4. **Ajustes** - Corre√ß√µes de estoque
5. **Hist√≥rico** - Invent√°rios conclu√≠dos

### üìù Formul√°rios (3)

#### 1. Criar Invent√°rio
- **Campos:** Nome, Tipo (Total/Parcial/C√≠clico), Locais, Categorias, Data In√≠cio, Respons√°veis
- **Submit:** POST `/api/inventario/criar`

#### 2. Registrar Contagem
- **Campos:** Produto (QR Code), Quantidade Contada, Lote, Validade, Local
- **Submit:** POST `/api/inventario/:id/contar`

#### 3. Ajustar Diverg√™ncia
- **Campos:** Produto, Motivo Diverg√™ncia, Quantidade Ajustada, Aprovador
- **Submit:** POST `/api/inventario/:id/ajustar`

### üé® Componentes

- `QRScanner` - Leitor de QR Code (c√¢mera)
- `RFIDReader` - Leitor RFID
- `DivergenceTable` - Tabela de diverg√™ncias
- `AccuracyGauge` - Gauge de acuracidade

### üîß Funcionalidades Frontend

**Scanner QR Code:**
```tsx
import { Html5QrcodeScanner } from 'html5-qrcode';

const [scannedProduct, setScannedProduct] = useState(null);

useEffect(() => {
  const scanner = new Html5QrcodeScanner(
    "qr-reader",
    { fps: 10, qrbox: 250 },
    false
  );
  
  scanner.render(
    (decodedText) => {
      // QR Code scaneado
      buscarProdutoPorCodigo(decodedText);
      scanner.clear();
    },
    (error) => console.error(error)
  );
  
  return () => scanner.clear();
}, []);

<div id="qr-reader" style={{ width: "100%" }} />
```

**Tela de Contagem:**
```tsx
<Card>
  <CardHeader>
    <CardTitle>Contagem: {inventario.nome}</CardTitle>
    <CardDescription>
      Progresso: {contagemFeita}/{totalItens} ({percentualConcluido}%)
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Progress value={percentualConcluido} className="mb-4" />
    
    {scannedProduct ? (
      <div className="space-y-4">
        <div className="flex items-center gap-4">
          <img src={scannedProduct.foto} className="w-20 h-20 object-cover rounded" />
          <div>
            <h3 className="font-semibold">{scannedProduct.nome}</h3>
            <p className="text-sm text-muted-foreground">
              Estoque Sistema: {scannedProduct.quantidade_sistema}
            </p>
          </div>
        </div>
        
        <div className="grid grid-cols-2 gap-4">
          <div>
            <Label>Quantidade F√≠sica</Label>
            <Input
              type="number"
              value={quantidadeFisica}
              onChange={(e) => setQuantidadeFisica(e.target.value)}
              autoFocus
            />
          </div>
          <div>
            <Label>Lote</Label>
            <Input value={lote} onChange={(e) => setLote(e.target.value)} />
          </div>
        </div>
        
        <Button onClick={registrarContagem} className="w-full">
          Registrar Contagem
        </Button>
      </div>
    ) : (
      <div className="text-center py-8">
        <QrCode size={48} className="mx-auto text-gray-400 mb-4" />
        <p className="text-muted-foreground">Escaneie o QR Code do produto</p>
      </div>
    )}
  </CardContent>
</Card>
```

### ‚öôÔ∏è Backend

**APIs:**

**POST `/api/inventario/criar`**
```typescript
Body: {
  nome, tipo, locais, categorias, 
  data_inicio, responsaveis
}
Response: {
  id, status: "criado",
  total_itens, mensagem
}
```

**POST `/api/inventario/:id/contar`**
```typescript
Body: {
  produto_id, quantidade_fisica, lote, validade, local
}
Response: {
  divergencia: boolean,
  diferenca: number,
  percentual_divergencia: number
}
```

**GET `/api/inventario/:id/relatorio`**
```typescript
Response: {
  inventario: {...},
  estatisticas: {
    total_itens: 1500,
    itens_contados: 1450,
    divergencias: 45,
    acuracia: 97.0,
    valor_divergencia: 15420.50
  },
  divergencias: [...]
}
```

### üîå Integra√ß√µes

**Internas:** Estoque IA, Produtos OPME  
**Externas:** Leitores RFID via Bluetooth

---

## 12. RH GEST√ÉO DE PESSOAS

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `RHGest√£oPessoasNovo.tsx` |
| **√çcone** | `Users` (Lucide React) |
| **Rota** | `/rh` |
| **Permiss√£o** | `rh.view, rh.manage` |
| **Status** | ‚úÖ Implementado 100% |

### üéØ Descri√ß√£o

Gest√£o de colaboradores com controle de ponto, f√©rias, benef√≠cios, treinamentos, avalia√ß√µes de desempenho e folha de pagamento integrada.

### üìã Sub-M√≥dulos (8)

1. **Colaboradores** - CRUD de funcion√°rios
2. **Ponto Eletr√¥nico** - Registro de hor√°rios
3. **F√©rias** - Solicita√ß√£o e aprova√ß√£o
4. **Benef√≠cios** - VT, VR, VA, Plano Sa√∫de
5. **Treinamentos** - Cursos e certifica√ß√µes
6. **Avalia√ß√µes** - Performance reviews
7. **Folha de Pagamento** - Processamento mensal
8. **Documentos** - Reposit√≥rio de docs

### üìù Formul√°rios (5)

#### 1. Cadastrar Colaborador
- **Campos:** Nome, CPF, RG, Data Nascimento, Cargo, Departamento, Sal√°rio, Data Admiss√£o, Tipo Contrato
- **Submit:** POST `/api/rh/colaboradores`

#### 2. Solicitar F√©rias
- **Campos:** Per√≠odo (data in√≠cio/fim), Observa√ß√µes
- **Submit:** POST `/api/rh/ferias/solicitar`

#### 3. Registrar Treinamento
- **Campos:** Colaborador, Curso, Institui√ß√£o, Data, Carga Hor√°ria, Certificado
- **Submit:** POST `/api/rh/treinamentos`

#### 4. Avaliar Desempenho
- **Campos:** Colaborador, Per√≠odo, Compet√™ncias (nota 1-5), Coment√°rios, Plano Desenvolvimento
- **Submit:** POST `/api/rh/avaliacoes`

#### 5. Processar Folha
- **Campos:** M√™s/Ano, Colaboradores, Horas Extras, Descontos, Benef√≠cios
- **Submit:** POST `/api/rh/folha/processar`

### üé® Componentes

- `EmployeeCard` - Card de colaborador
- `TimeTracker` - Registro de ponto
- `VacationCalendar` - Calend√°rio de f√©rias
- `PayrollTable` - Tabela de folha
- `PerformanceRadar` - Gr√°fico radar de compet√™ncias

### üîß Funcionalidades Frontend

**Dashboard RH:**
```tsx
<div className="grid grid-cols-4 gap-4">
  <Card>
    <CardHeader>
      <CardTitle>Total Colaboradores</CardTitle>
    </CardHeader>
    <CardContent>
      <p className="text-4xl font-bold">{stats.total_colaboradores}</p>
      <p className="text-sm text-muted-foreground">
        <span className="text-green-500">+{stats.admissoes_mes}</span> este m√™s
      </p>
    </CardContent>
  </Card>
  
  <Card>
    <CardHeader>
      <CardTitle>Em F√©rias</CardTitle>
    </CardHeader>
    <CardContent>
      <p className="text-4xl font-bold">{stats.em_ferias}</p>
    </CardContent>
  </Card>
  
  <Card>
    <CardHeader>
      <CardTitle>Folha Mensal</CardTitle>
    </CardHeader>
    <CardContent>
      <p className="text-4xl font-bold">
        {formatCurrency(stats.folha_mensal)}
      </p>
    </CardContent>
  </Card>
  
  <Card>
    <CardHeader>
      <CardTitle>Treinamentos</CardTitle>
    </CardHeader>
    <CardContent>
      <p className="text-4xl font-bold">{stats.treinamentos_mes}</p>
      <p className="text-sm text-muted-foreground">
        {stats.horas_treinamento}h este m√™s
      </p>
    </CardContent>
  </Card>
</div>
```

**Ponto Eletr√¥nico:**
```tsx
<Card>
  <CardHeader>
    <CardTitle>Registro de Ponto</CardTitle>
  </CardHeader>
  <CardContent>
    <div className="text-center mb-6">
      <p className="text-6xl font-mono">{horarioAtual}</p>
      <p className="text-sm text-muted-foreground mt-2">
        {format(new Date(), "EEEE, dd 'de' MMMM 'de' yyyy", { locale: ptBR })}
      </p>
    </div>
    
    <div className="space-y-2 mb-6">
      {registrosHoje.map(registro => (
        <div key={registro.id} className="flex justify-between items-center p-2 border rounded">
          <span className="font-medium">{registro.tipo}</span>
          <span>{format(new Date(registro.timestamp), 'HH:mm:ss')}</span>
        </div>
      ))}
    </div>
    
    <Button
      onClick={registrarPonto}
      className="w-full"
      size="lg"
      disabled={ultimoRegistro?.tipo === proximoTipo}
    >
      <Clock size={20} className="mr-2" />
      {proximoTipo === 'entrada' && 'Registrar Entrada'}
      {proximoTipo === 'saida_almoco' && 'Sa√≠da Almo√ßo'}
      {proximoTipo === 'volta_almoco' && 'Volta Almo√ßo'}
      {proximoTipo === 'saida' && 'Registrar Sa√≠da'}
    </Button>
  </CardContent>
</Card>
```

### ‚öôÔ∏è Backend

**GET `/api/rh/colaboradores/:id/ponto/mes`**
```typescript
Response: {
  mes, ano,
  registros: [
    { data, entrada, saida_almoco, volta_almoco, saida, total_horas }
  ],
  resumo: {
    total_horas_mes: 176,
    horas_extras: 12,
    faltas: 0,
    atrasos: 2
  }
}
```

**POST `/api/rh/folha/processar`**
```typescript
Body: { mes, ano, colaboradores_ids }
Response: {
  folha_id,
  valor_total_bruto,
  valor_total_liquido,
  total_encargos,
  processada_em
}
```

### üîå Integra√ß√µes

**Internas:** Usu√°rios, Financeiro  
**Externas:** eSocial, FGTS Digital, Plataformas de RH

---

## 13. RELACIONAMENTO COM CLIENTE

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `RelacionamentoClienteNovo.tsx` |
| **√çcone** | `Heart` (Lucide React) |
| **Rota** | `/crm/relacionamento` |
| **Permiss√£o** | `crm.view` |
| **Status** | ‚úÖ Implementado 100% |

### üéØ Descri√ß√£o

Gest√£o de relacionamento com clientes (hospitais e m√©dicos) incluindo hist√≥rico de intera√ß√µes, prefer√™ncias, NPS, satisfa√ß√£o, suporte e fideliza√ß√£o.

### üìã Sub-M√≥dulos (6)

1. **Perfil do Cliente** - 360¬∞ view
2. **Hist√≥rico de Intera√ß√µes** - Timeline
3. **Pesquisas de Satisfa√ß√£o** - NPS, CSAT
4. **Programa de Fidelidade** - Pontua√ß√£o e benef√≠cios
5. **Suporte/Tickets** - Atendimento
6. **Comunica√ß√£o** - Email, WhatsApp, SMS

### üìù Formul√°rios (4)

#### 1. Registrar Intera√ß√£o
- **Campos:** Cliente, Tipo (Visita/Liga√ß√£o/Email/Reuni√£o), Data, Respons√°vel, Assunto, Notas, Pr√≥ximo Follow-up
- **Submit:** POST `/api/crm/interacoes`

#### 2. Enviar Pesquisa NPS
- **Campos:** Clientes, Mensagem Personalizada
- **Submit:** POST `/api/crm/nps/enviar`

#### 3. Abrir Ticket
- **Campos:** Cliente, Tipo (D√∫vida/Reclama√ß√£o/Solicita√ß√£o), Prioridade, Descri√ß√£o, Anexos
- **Submit:** POST `/api/crm/tickets`

#### 4. Criar Campanha Comunica√ß√£o
- **Campos:** Nome, Segmento Clientes, Canal, Mensagem, Data Envio
- **Submit:** POST `/api/crm/campanhas`

### üé® Componentes

- `ClientProfile360` - Perfil completo
- `InteractionTimeline` - Timeline de intera√ß√µes
- `NPSGauge` - Gauge de NPS
- `TicketList` - Lista de tickets
- `WhatsAppChat` - Chat integrado

### üîß Funcionalidades Frontend

**Perfil 360¬∞ do Cliente:**
```tsx
<div className="grid grid-cols-3 gap-6">
  {/* Informa√ß√µes Gerais */}
  <Card className="col-span-1">
    <CardHeader>
      <div className="flex items-center gap-4">
        <Avatar className="w-20 h-20">
          <AvatarImage src={cliente.logo} />
          <AvatarFallback>{cliente.iniciais}</AvatarFallback>
        </Avatar>
        <div>
          <CardTitle>{cliente.nome}</CardTitle>
          <CardDescription>{cliente.cidade} - {cliente.uf}</CardDescription>
        </div>
      </div>
    </CardHeader>
    <CardContent>
      <div className="space-y-3">
        <div className="flex justify-between">
          <span className="text-sm text-muted-foreground">NPS</span>
          <Badge variant={cliente.nps >= 9 ? 'default' : cliente.nps >= 7 ? 'secondary' : 'destructive'}>
            {cliente.nps}/10
          </Badge>
        </div>
        <div className="flex justify-between">
          <span className="text-sm text-muted-foreground">Cliente desde</span>
          <span>{format(new Date(cliente.data_cadastro), 'MMM yyyy')}</span>
        </div>
        <div className="flex justify-between">
          <span className="text-sm text-muted-foreground">√öltima compra</span>
          <span>{formatDistanceToNow(new Date(cliente.ultima_compra), { addSuffix: true })}</span>
        </div>
        <Separator />
        <div className="flex justify-between">
          <span className="text-sm text-muted-foreground">LTV</span>
          <span className="font-semibold">{formatCurrency(cliente.ltv)}</span>
        </div>
      </div>
    </CardContent>
  </Card>
  
  {/* M√©tricas */}
  <Card className="col-span-2">
    <CardHeader>
      <CardTitle>M√©tricas de Relacionamento</CardTitle>
    </CardHeader>
    <CardContent>
      <div className="grid grid-cols-4 gap-4">
        <div>
          <span className="text-sm text-muted-foreground">Total Compras</span>
          <p className="text-2xl font-semibold">{cliente.total_compras}</p>
        </div>
        <div>
          <span className="text-sm text-muted-foreground">Ticket M√©dio</span>
          <p className="text-2xl font-semibold">{formatCurrency(cliente.ticket_medio)}</p>
        </div>
        <div>
          <span className="text-sm text-muted-foreground">Intera√ß√µes</span>
          <p className="text-2xl font-semibold">{cliente.total_interacoes}</p>
        </div>
        <div>
          <span className="text-sm text-muted-foreground">Tickets Abertos</span>
          <p className="text-2xl font-semibold">{cliente.tickets_abertos}</p>
        </div>
      </div>
      
      {/* Gr√°fico de Compras */}
      <div className="mt-6">
        <h4 className="text-sm font-medium mb-3">Hist√≥rico de Compras (12 meses)</h4>
        <ResponsiveContainer width="100%" height={200}>
          <AreaChart data={cliente.historico_compras}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="mes" />
            <YAxis />
            <Tooltip formatter={(value) => formatCurrency(value)} />
            <Area type="monotone" dataKey="valor" stroke="#6366F1" fill="#6366F1" fillOpacity={0.2} />
          </AreaChart>
        </ResponsiveContainer>
      </div>
    </CardContent>
  </Card>
  
  {/* Timeline de Intera√ß√µes */}
  <Card className="col-span-3">
    <CardHeader>
      <CardTitle>Timeline de Intera√ß√µes</CardTitle>
    </CardHeader>
    <CardContent>
      <InteractionTimeline interacoes={cliente.interacoes} />
    </CardContent>
  </Card>
</div>
```

### ‚öôÔ∏è Backend

**GET `/api/crm/clientes/:id/perfil360`**
```typescript
Response: {
  cliente: {...},
  metricas: {
    total_compras, ticket_medio, ltv, nps,
    total_interacoes, tickets_abertos
  },
  historico_compras: [...],
  interacoes: [...],
  tickets: [...]
}
```

**POST `/api/crm/nps/enviar`**
```typescript
Body: { clientes_ids, mensagem }
Response: {
  enviados: 150,
  falhas: 2,
  link_pesquisa
}
```

### üîå Integra√ß√µes

**Internas:** Hospitais, M√©dicos, Vendas, Faturamento  
**Externas:** Twilio (WhatsApp), SendGrid (Email), Typeform (Pesquisas)

---

## 14. GEST√ÉO DE LEADS

### üìä Informa√ß√µes Gerais

| Atributo | Valor |
|----------|-------|
| **Arquivo** | `GestaoLeadsNovo.tsx` |
| **√çcone** | `Target` (Lucide React) |
| **Rota** | `/crm/leads` |
| **Permiss√£o** | `leads.manage` |
| **Status** | ‚úÖ Implementado 100% |

### üéØ Descri√ß√£o

Gerenciamento de pipeline de vendas com qualifica√ß√£o de leads, scoring autom√°tico, distribui√ß√£o inteligente, follow-ups e convers√£o em clientes.

### üìã Sub-M√≥dulos (5)

1. **Pipeline Kanban** - Visualiza√ß√£o do funil
2. **Qualifica√ß√£o** - Scoring e categoriza√ß√£o
3. **Distribui√ß√£o** - Atribui√ß√£o autom√°tica
4. **Follow-ups** - Lembretes e tarefas
5. **Convers√£o** - Transformar em cliente

### üìù Formul√°rios (3)

#### 1. Criar Lead
- **Campos:** Nome Hospital/Cl√≠nica, Contato, Telefone, Email, Fonte, Interesse, Observa√ß√µes
- **Submit:** POST `/api/crm/leads`

#### 2. Qualificar Lead
- **Campos:** Score (1-100), Temperatura (Frio/Morno/Quente), Pr√≥xima A√ß√£o, Data Follow-up
- **Submit:** PUT `/api/crm/leads/:id/qualificar`

#### 3. Converter em Cliente
- **Campos:** Dados Completos, Valor Primeira Compra, Condi√ß√µes Comerciais
- **Submit:** POST `/api/crm/leads/:id/converter`

### üé® Componentes

- `KanbanBoard` (react-beautiful-dnd) - Pipeline drag-and-drop
- `LeadScoreGauge` - Gauge de score
- `DistributionRules` - Regras de distribui√ß√£o
- `FollowUpCalendar` - Calend√°rio de follow-ups

### üîß Funcionalidades Frontend

**Pipeline Kanban:**
```tsx
import { DragDropContext, Droppable, Draggable } from 'react-beautiful-dnd';

const [pipeline, setPipeline] = useState({
  novo: [...],
  qualificado: [...],
  proposta: [...],
  negociacao: [...],
  fechado: [...]
});

const onDragEnd = (result) => {
  if (!result.destination) return;
  
  const { source, destination } = result;
  
  if (source.droppableId !== destination.droppableId) {
    // Mover para outro est√°gio
    moverLead(result.draggableId, destination.droppableId);
  }
};

<DragDropContext onDragEnd={onDragEnd}>
  <div className="grid grid-cols-5 gap-4">
    {Object.entries(pipeline).map(([estagio, leads]) => (
      <div key={estagio}>
        <h3 className="font-semibold mb-3">
          {estagio} ({leads.length})
        </h3>
        
        <Droppable droppableId={estagio}>
          {(provided) => (
            <div
              ref={provided.innerRef}
              {...provided.droppableProps}
              className="space-y-2 min-h-[500px]"
            >
              {leads.map((lead, index) => (
                <Draggable key={lead.id} draggableId={lead.id} index={index}>
                  {(provided) => (
                    <Card
                      ref={provided.innerRef}
                      {...provided.draggableProps}
                      {...provided.dragHandleProps}
                    >
                      <CardHeader className="p-3">
                        <CardTitle className="text-sm">{lead.nome}</CardTitle>
                      </CardHeader>
                      <CardContent className="p-3 pt-0">
                        <div className="space-y-2">
                          <Badge variant={lead.temperatura === 'quente' ? 'default' : 'secondary'}>
                            {lead.temperatura}
                          </Badge>
                          <p className="text-xs text-muted-foreground">
                            Score: {lead.score}/100
                          </p>
                          <p className="text-xs">
                            {formatCurrency(lead.valor_estimado)}
                          </p>
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
      </div>
    ))}
  </div>
</DragDropContext>
```

### ‚öôÔ∏è Backend

**GET `/api/crm/leads/pipeline`**
```typescript
Response: {
  pipeline: {
    novo: [{ id, nome, score, temperatura, valor_estimado }],
    qualificado: [...],
    proposta: [...],
    negociacao: [...],
    fechado: [...]
  },
  estatisticas: {
    total_leads: 150,
    taxa_conversao: 32.5,
    tempo_medio_conversao: 15
  }
}
```

**PUT `/api/crm/leads/:id/mover`**
```typescript
Body: { estagio_destino }
Response: { status: "movido" }
```

**POST `/api/crm/leads/:id/converter`**
```typescript
Body: { dados_completos, valor_primeira_compra }
Response: {
  cliente_id,
  mensagem: "Lead convertido em cliente"
}
```

### üîå Integra√ß√µes

**Internas:** Cadastros (Hospitais), CRM Vendas  
**Externas:** RD Station, HubSpot (importa√ß√£o de leads)

---

**Progresso:** 14/58 m√≥dulos (24%)  
**Total acumulado:** ~95.000 palavras

**Continuando com CATEGORIA 3: CIRURGIAS & PROCEDIMENTOS...**